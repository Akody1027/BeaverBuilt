<!-- customer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Tracker – Delivery Tracker</title>
  <style>
    body, html { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; }
    #eta { position: fixed; top: 10px; right: 10px; background: #fff;
           padding: 8px; border-radius: 4px; z-index: 999; }
    #debug { position: fixed; bottom: 0; left: 0; width: 100%; font-size: 12px;
             background: rgba(0,0,0,0.7); color: #fff; max-height: 100px;
             overflow: auto; z-index: 9999; padding: 5px; }
  </style>
</head>
<body>
  <div id="eta">ETA: calculating…</div>
  <div id="map"></div>
  <div id="debug"><strong>Debug:</strong><br></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Google Maps JS (replace YOUR_GOOGLE_MAPS_API_KEY) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

  <script>
    // Firebase config – replace with your own
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    let customerMap;
    const debugLog = msg => document.getElementById('debug').innerHTML += msg + '<br>';

    function initMap() {
      customerMap = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.773, lng: -122.431 }, zoom: 12
      });

      // Listen for driver updates
      const driverRef = firebase.database().ref('drivers/driver1');
      driverRef.on('value', snap => {
        const data = snap.val();
        if (!data) return debugLog('No driver data yet');
        const { lat, lng, timestamp } = data;
        debugLog(`Got driver update: ${lat.toFixed(5)},${lng.toFixed(5)} @ ${new Date(timestamp).toLocaleTimeString()}`);

        // marker
        if (!window.driverMarker) {
          window.driverMarker = new google.maps.Marker({ position: { lat, lng }, map: customerMap });
        } else {
          window.driverMarker.setPosition({ lat, lng });
        }

        customerMap.panTo({ lat, lng });
        updateETA({ lat, lng });
      });
    }

    function updateETA(origin) {
      // assume fixed customer destination; replace with dynamic if needed
      const customerDestination = window.customerDestination || { lat: 37.7749, lng: -122.4194 };
      const ds = new google.maps.DirectionsService();
      ds.route({ origin, destination: customerDestination, travelMode: 'DRIVING' }, (res, status) => {
        if (status === 'OK') {
          const leg = res.routes[0].legs[0];
          document.getElementById('eta').innerText = 'ETA: ' + leg.duration.text;
          debugLog('ETA updated: ' + leg.duration.text);
        } else debugLog('ETA route error: ' + status);
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
