<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <!-- Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: #fafafa; }
    .dashboard-card { background: #fff; border-radius: 1rem; box-shadow: 0 2px 16px #0001; }
    .invoice-status-unpaid { background: #fecaca; color: #b91c1c; }
    .invoice-status-paid { background: #bbf7d0; color: #166534; }
    .modal-bg { position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(31,41,55,0.7);}
    .modal { background:#fff; border-radius:1.2rem; max-width:96vw; width:420px; box-shadow:0 8px 32px #0002; padding:2rem 2rem 1.2rem 2rem; position:relative;}
    .modal .close-modal { position:absolute;top:8px;right:18px;cursor:pointer;font-size:1.7rem;color:#e11d48;font-weight:700;}
    .modal .close-modal:hover { color:#b91c1c; }
    .receipt-link { color: #06b6d4; text-decoration: underline; cursor: pointer;}
  </style>
</head>
<body class="h-screen flex flex-col">

  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Customer Login</h2>
      <input id="customer-pin" type="password" maxlength="4" placeholder="Enter your 4-digit PIN" class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-pink-300">
      <button id="login-btn" class="w-full py-4 bg-gray-200 text-black rounded-lg hover:bg-gray-300 text-lg font-semibold flex justify-center items-center">
        <span id="login-btn-text">Login</span>
        <span id="login-btn-spinner" class="spinner hidden"></span>
      </button>
      <p id="pin-error" class="mt-2 text-red-600"></p>
    </div>
  </div>

  <!-- Main Layout -->
  <div id="main" class="hidden flex-1 flex flex-col">
    <header class="bg-white shadow-md">
      <div class="px-4 py-3 flex items-center">
        <h2 class="text-xl font-semibold text-gray-900">Customer Portal</h2>
      </div>
    </header>
    <main class="flex-1 max-w-2xl w-full mx-auto p-6 space-y-8">
      <!-- Welcome -->
      <section>
        <div class="dashboard-card p-6 mb-4 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold mb-2" id="welcome-name">Welcome!</h3>
            <div class="text-gray-600 text-sm">Customer ID: <span id="welcome-id"></span></div>
            <div class="text-gray-600 text-sm">PIN: <span id="welcome-pin"></span></div>
          </div>
          <button id="logout-btn" class="rounded bg-gray-100 hover:bg-gray-200 px-3 py-2 text-gray-700 font-medium text-sm">Log Out</button>
        </div>
      </section>
      <!-- Invoices -->
      <section>
        <h3 class="text-lg font-bold mb-3">Your Invoices</h3>
        <div id="invoices-list" class="space-y-4"></div>
      </section>
      <!-- Update Info -->
      <section>
        <h3 class="text-lg font-bold mb-3">Update Your Info</h3>
        <form id="update-form" class="dashboard-card p-6 flex flex-col gap-3">
          <input id="input-name" placeholder="Name" class="rounded border px-3 py-2" autocomplete="name">
          <input id="input-email" type="email" placeholder="Email" class="rounded border px-3 py-2" autocomplete="email">
          <input id="input-phone" type="tel" placeholder="Phone Number" class="rounded border px-3 py-2" autocomplete="tel">
          <input id="input-address" placeholder="Address" class="rounded border px-3 py-2" autocomplete="street-address">
          <button class="rounded bg-gray-300 hover:bg-gray-400 text-black py-2 font-semibold mt-2" type="submit">Update Info</button>
          <div id="update-feedback" class="text-green-700 font-semibold"></div>
        </form>
      </section>
    </main>
  </div>

  <!-- Modal (for receipt/download in demo) -->
  <div id="receipt-modal-bg" class="modal-bg" style="display:none;">
    <div class="modal">
      <div class="close-modal" id="close-receipt-modal">&times;</div>
      <h4 class="text-lg font-bold mb-3">Your Receipt</h4>
      <div id="receipt-content" class="mb-2 text-gray-700"></div>
      <button id="download-receipt" class="rounded bg-gray-300 hover:bg-gray-400 py-2 px-4 text-black font-semibold">Download PDF (Demo)</button>
    </div>
  </div>

  <script>
    // Spinner CSS for login
    if (!document.querySelector('.spinner')) {
      var s = document.createElement('style');
      s.innerHTML = `.spinner{display:inline-block;width:1.4em;height:1.4em;border:3px solid #cbd5e1;border-top:3px solid #64748b;border-radius:50%;animation:spin 1s linear infinite;}@keyframes spin{100%{transform:rotate(360deg);}}`;
      document.head.appendChild(s);
    }

    // Firebase config and Firestore init
    const firebaseConfig = {
      apiKey: "AIzaSyB2lKzEGU4YWV9-E9XILI3Gy0v80F2hJFc",
      authDomain: "customerportal-3032d.firebaseapp.com",
      projectId: "customerportal-3032d",
      storageBucket: "customerportal-3032d.firebasestorage.app",
      messagingSenderId: "1003504088676",
      appId: "1:1003504088676:web:43453e986312257b2f5171",
      measurementId: "G-CVC0HK0WP8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // State
    let loggedIn = false;
    let currentCustomer = null;

    // Elements
    const overlay = document.getElementById('login-overlay');
    const loginBtn = document.getElementById('login-btn');
    const pinInput = document.getElementById('customer-pin');
    const pinError = document.getElementById('pin-error');
    const main = document.getElementById('main');
    const welcomeName = document.getElementById('welcome-name');
    const welcomeID = document.getElementById('welcome-id');
    const welcomePIN = document.getElementById('welcome-pin');
    const invoicesList = document.getElementById('invoices-list');
    const updateForm = document.getElementById('update-form');
    const updateFeedback = document.getElementById('update-feedback');
    const logoutBtn = document.getElementById('logout-btn');
    // Modal
    const receiptModalBg = document.getElementById('receipt-modal-bg');
    const receiptContent = document.getElementById('receipt-content');
    const closeReceiptModal = document.getElementById('close-receipt-modal');
    const downloadReceipt = document.getElementById('download-receipt');

    // Helper to show/hide spinner
    function showLoginSpinner(show) {
      document.getElementById('login-btn-text').classList.toggle('hidden', show);
      document.getElementById('login-btn-spinner').classList.toggle('hidden', !show);
    }

    // Login logic using Firestore
    loginBtn.onclick = async function() {
      pinError.textContent = "";
      showLoginSpinner(true);
      try {
        let pin = pinInput.value.trim();
        // Query for customer by PIN
        let querySnapshot = await db.collection("customers").where("pin", "==", pin).get();
        let customer = null;
        querySnapshot.forEach(doc => customer = { id: doc.id, ...doc.data() });

        if (!customer) {
          pinError.textContent = "Invalid PIN.";
          showLoginSpinner(false);
          return;
        }
        currentCustomer = customer;
        loggedIn = true;
        overlay.classList.add('hidden');
        main.classList.remove('hidden');
        renderCustomer();
      } catch (e) {
        pinError.textContent = "Login error: " + e;
      }
      showLoginSpinner(false);
    };

    logoutBtn.onclick = function() {
      overlay.classList.remove('hidden');
      main.classList.add('hidden');
      pinInput.value = '';
      pinError.textContent = '';
      currentCustomer = null;
      loggedIn = false;
    };

    function renderCustomer() {
      if (!currentCustomer) return;
      welcomeName.textContent = `Welcome, ${currentCustomer.name || 'Customer'}!`;
      welcomeID.textContent = currentCustomer.id || '';
      welcomePIN.textContent = currentCustomer.pin || '';
      // Populate update info
      document.getElementById('input-name').value = currentCustomer.name || '';
      document.getElementById('input-email').value = currentCustomer.email || '';
      document.getElementById('input-phone').value = currentCustomer.phone || '';
      document.getElementById('input-address').value = currentCustomer.address || '';
      // Invoices
      renderInvoices();
    }

    async function renderInvoices() {
      invoicesList.innerHTML = '';
      if (!currentCustomer) return;
      // Query Firestore for bills tied to this customer
      let querySnapshot = await db.collection("bills").where("customerId", "==", currentCustomer.id).get();
      let bills = [];
      querySnapshot.forEach(doc => bills.push({ ...doc.data(), id: doc.id }));

      if (bills.length === 0) {
        invoicesList.innerHTML = `<div class="dashboard-card p-4 text-gray-500">No invoices found.</div>`;
        return;
      }
      bills.forEach((bill, idx) => {
        let paid = !!bill.paid;
        let div = document.createElement('div');
        div.className = 'dashboard-card p-5 flex flex-col gap-2 ' + (paid ? 'invoice-status-paid' : 'invoice-status-unpaid');
        div.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span class="font-semibold">Invoice #${idx + 1}</span>
            <span class="text-xs">${paid ? 'Paid' : 'Unpaid'}</span>
          </div>
          <div>Amount: <span class="font-bold">$${bill.amount}</span></div>
          <div>Due: ${bill.dueDate}</div>
        `;
        // Payment or receipt
        if (!paid) {
          // Stripe: Demo button
          let stripeBtn = document.createElement('button');
          stripeBtn.className = 'rounded bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 mt-2 mb-1 font-semibold text-sm';
          stripeBtn.textContent = "Pay with Stripe";
          stripeBtn.onclick = function() {
            alert('Stripe integration not yet set up.');
          };
          // Venmo/CashApp: Demo links
          let venmo = document.createElement('a');
          venmo.href = "https://venmo.com/"; venmo.target="_blank";
          venmo.className = 'rounded bg-gray-200 hover:bg-gray-300 text-black px-3 py-1 mt-1 mr-2 text-sm inline-block';
          venmo.textContent = "Venmo";
          let cashapp = document.createElement('a');
          cashapp.href = "https://cash.app/"; cashapp.target="_blank";
          cashapp.className = 'rounded bg-gray-200 hover:bg-gray-300 text-black px-3 py-1 mt-1 text-sm inline-block';
          cashapp.textContent = "Cash App";
          let row = document.createElement('div');
          row.className = "flex flex-wrap gap-2 items-center mt-2";
          row.appendChild(stripeBtn);
          row.appendChild(venmo);
          row.appendChild(cashapp);
          div.appendChild(row);
        } else {
          // Show download receipt
          let receiptBtn = document.createElement('span');
          receiptBtn.className = 'receipt-link ml-1';
          receiptBtn.textContent = "Download Receipt";
          receiptBtn.onclick = function() {
            document.getElementById('receipt-content').innerHTML = `
              <div class="font-bold mb-1 text-green-700">Invoice Receipt</div>
              <div><strong>Invoice #:</strong> ${idx + 1}</div>
              <div><strong>Name:</strong> ${currentCustomer.name}</div>
              <div><strong>ID:</strong> ${currentCustomer.id}</div>
              <div><strong>Amount:</strong> $${bill.amount}</div>
              <div><strong>Status:</strong> Paid</div>
              <div><strong>Date Paid:</strong> ${bill.dueDate}</div>
            `;
            receiptModalBg.style.display = 'flex';
          };
          let row = document.createElement('div');
          row.className = "flex gap-2 items-center mt-2";
          row.appendChild(receiptBtn);
          div.appendChild(row);
        }
        invoicesList.appendChild(div);
      });
    }

    // Close receipt modal
    closeReceiptModal.onclick = function() { receiptModalBg.style.display = 'none'; };
    downloadReceipt.onclick = function() { alert("Demo: Would download PDF here."); };

    // Update info form
    updateForm.onsubmit = async function(e) {
      e.preventDefault();
      if (!currentCustomer) return;
      // Write to Firestore
      var name = document.getElementById('input-name').value.trim();
      var email = document.getElementById('input-email').value.trim();
      var phone = document.getElementById('input-phone').value.trim();
      var address = document.getElementById('input-address').value.trim();
      // Update Firestore
      try {
        await db.collection("customers").doc(currentCustomer.id).update({
          name, email, phone, address
        });
        currentCustomer.name = name;
        currentCustomer.email = email;
        currentCustomer.phone = phone;
        currentCustomer.address = address;
        updateFeedback.textContent = "Information updated!";
        welcomeName.textContent = `Welcome, ${currentCustomer.name || 'Customer'}!`;
        setTimeout(() => { updateFeedback.textContent = ''; }, 2000);
      } catch (e) {
        updateFeedback.textContent = "Update failed: " + e;
      }
    };
  </script>
</body>
</html>
