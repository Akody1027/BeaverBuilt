<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visitor Chat – BeaverBuilt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: #eee;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    h2 {
      margin-top: 20px;
    }
    #messages {
      width: 90%;
      max-width: 480px;
      flex: 1;
      margin: 20px 0;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #input-container {
      width: 90%;
      max-width: 480px;
      display: flex;
      margin-bottom: 20px;
    }
    #message-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px 0 0 8px;
      background: #242424;
      color: #eee;
      font-size: 1rem;
    }
    #send-button {
      background: #333;
      border: 1px solid #333;
      border-left: none;
      border-radius: 0 8px 8px 0;
      color: #eee;
      padding: 12px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Visitor Chat</h2>
  <div id="messages"></div>
  <div id="input-container">
    <input id="message-input" type="text" placeholder="Type your message…" autocomplete="off" />
    <button id="send-button">Send</button>
  </div>

  <!-- ✅ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-database-compat.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ✅ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCZ5Kmh9XjZKYGJBbEL6qUR3QsPpXY8K1o",
        authDomain: "beaverbuiltchat.firebaseapp.com",
        databaseURL: "https://beaverbuiltchat-default-rtdb.firebaseio.com",
        projectId: "beaverbuiltchat",
        storageBucket: "beaverbuiltchat.appspot.com",
        messagingSenderId: "785578451247",
        appId: "1:785578451247:web:30d2422f3b318032c9c1da",
        measurementId: "G-XT02YCCFYM"
      };

      // ✅ Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ✅ Reuse or create a visitor UID
      let visitorUid = localStorage.getItem("visitorUid");
      if (!visitorUid) {
        const refToNewThread = db.ref("threads").push();
        visitorUid = refToNewThread.key;
        localStorage.setItem("visitorUid", visitorUid);
      }

      const threadRef = db.ref("threads/" + visitorUid);
      const messagesDiv = document.getElementById("messages");
      const inputBox = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-button");

      // ✅ Show messages live
      threadRef.on("child_added", snapshot => {
        const m = snapshot.val();
        const p = document.createElement("div");
        p.textContent = (m.sender === "visitor" ? "You: " : "Admin: ") + m.text;
        p.style.padding = "8px 12px";
        p.style.margin = "6px 0";
        p.style.borderRadius = "12px";
        p.style.maxWidth = "80%";
        p.style.whiteSpace = "pre-wrap";
        p.style.alignSelf = m.sender === "visitor" ? "flex-end" : "flex-start";
        p.style.background = m.sender === "visitor" ? "#444" : "#555";
        p.style.color = "#eee";
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      // ✅ Send message function
      function sendMessage() {
        const text = inputBox.value.trim();
        if (!text) return;

        threadRef.push({
          sender: "visitor",
          text: text,
          ts: Date.now()
        });

        inputBox.value = "";
      }

      // ✅ Event listeners
      sendBtn.addEventListener("click", sendMessage);
      inputBox.addEventListener("keypress", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>
