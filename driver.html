<!DOCTYPE html>
<html>
<head>
  <title>Driver Tracker</title>
  <style>
    #map { height: 400px; width: 100%; }
    #status { font-size: 18px; margin: 15px 0; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>Driver Tracker</h2>
  <div id="status">Status: <span id="driverStatus">Inactive</span></div>
  <button id="toggleButton">Go Active</button>
  <div id="map"></div>

  <!-- Firebase & Google Maps -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYk1zuUkelnUHH5u_w4NGSnUYKBzQpQFQ"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvDPrwPZAcnr4q9AGnVj0VTbPezoAtBMM",
      authDomain: "delivery-tracker-f3adc.firebaseapp.com",
      databaseURL: "https://delivery-tracker-f3adc.firebaseio.com",
      projectId: "delivery-tracker-f3adc",
      storageBucket: "delivery-tracker-f3adc.appspot.com",
      messagingSenderId: "934356625713",
      appId: "1:934356625713:web:b4bac3d9eb9d68c6fa2810",
      measurementId: "G-PT5072M6LC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const deliveryId = urlParams.get('id') || 'test_delivery';

    let map, marker, watchId;
    let isActive = false;

    const statusText = document.getElementById("driverStatus");
    const toggleButton = document.getElementById("toggleButton");

    function updateUI() {
      statusText.textContent = isActive ? "Active" : "Inactive";
      toggleButton.textContent = isActive ? "Go Inactive" : "Go Active";
    }

    toggleButton.onclick = () => {
      isActive = !isActive;
      db.ref("drivers/" + deliveryId + "/status").set(isActive ? "active" : "inactive");
      updateUI();

      if (isActive) {
        db.ref("drivers/" + deliveryId + "/createdAt").set(Date.now());
        startTracking();
      } else {
        stopTracking();
      }
    };

    function startTracking() {
      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude } = pos.coords;
          db.ref("drivers/" + deliveryId + "/location").set({ latitude, longitude });
          if (!map) initMap(latitude, longitude);
          else {
            marker.setPosition({ lat: latitude, lng: longitude });
            map.setCenter({ lat: latitude, lng: longitude });
          }
        }, err => alert("Location error: " + err.message), { enableHighAccuracy: true });
      } else {
        alert("Geolocation not supported.");
      }
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
    }

    function initMap(lat, lng) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat, lng },
        zoom: 15
      });
      marker = new google.maps.Marker({
        map,
        position: { lat, lng },
        title: "Driver Location"
      });
    }

    firebase.auth().signInAnonymously().catch(console.error);
  </script>
</body>
</html>
