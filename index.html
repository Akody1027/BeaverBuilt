<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Beaver Built Furniture</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <meta name="theme-color" content="black"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="apple-touch-icon" href="beaverlogo.png">
  <link rel="icon" href="beaverlogo.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-database-compat.js"></script>

  <style>
    /* Layout & Reset */
    html, body { margin:0; padding:0; height:100%; display:flex; flex-direction:column; font-family:Arial,sans-serif; }
    #viewport { flex:1; }
    #viewport iframe { width:100%; height:100%; border:none; }

    /* Cart Popover */
    #cart-popover {
      position: fixed; bottom: 70px; right: 15px;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 15px;
      width: 60%; max-width: 400px; max-height: 60vh; overflow-y: auto;
      display: none; z-index: 1001;
    }
    #cart-popover h3 { margin:0 0 10px; font-size:1.1rem; border-bottom:1px solid #eee; padding-bottom:5px; }
    .cart-item { display:flex; align-items:center; margin:8px 0; }
    .cart-item img { width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:10px; }
    .cart-item-name { flex:1; font-size:.95rem; }
    .quantity-controls { display:flex; align-items:center; margin:0 10px; }
    .quantity-button { background:#e5e7eb; border:none; border-radius:4px; width:20px; height:20px; line-height:18px; text-align:center; margin:0 4px; font-weight:bold; }
    .quantity-button:hover { background:#d1d5db; }
    .quantity-display { min-width:20px; text-align:center; }
    .cart-item-price { font-weight:bold; }
    #checkout-btn { width:100%; padding:10px; background:#1f2937; color:#fff; border:none; border-radius:6px; margin-top:10px; }
    #checkout-btn:hover { background:#374151; }

    /* Bottom Navigation */
    #bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 60px; background: rgba(17,17,17,0.9);
      display: flex; z-index: 1000;
    }
    #bottom-nav a {
      flex: 1;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 6px 0;
      color: #fff; font-size: .75rem; text-decoration: none;
      transition: background .2s;
      position: relative;
    }
    #bottom-nav a.active { background: rgba(255,255,255,0.1); }
    #bottom-nav .material-icons,
    #bottom-nav img { width:24px; height:24px; margin-bottom:2px; }
    #bottom-cart img { object-fit:contain; }
    .badge {
      position:absolute; top:4px; right:16px;
      background:#ff3b30; color:#fff; font-size:.65rem; font-weight:bold;
      border-radius:50%; padding:2px 5px; display:none;
    }
  </style>
</head>
<body>
  <!-- Viewport -->
  <div id="viewport">
    <iframe id="view-frame" src="home.html"></iframe>
  </div>

  <!-- Cart Popover -->
  <div id="cart-popover">
    <h3>Your Cart</h3>
    <div id="cart-items"></div>
    <p><strong>Total: $<span id="cart-total">0.00</span></strong></p>
    <button id="checkout-btn">Checkout</button>
  </div>

  <!-- Bottom Navigation -->
  <nav id="bottom-nav">
    <a href="#" data-src="home.html" class="nav-btn active">
      <span class="material-icons">home</span><span>Home</span>
    </a>
    <a href="#" data-src="furniture.html" class="nav-btn">
      <span class="material-icons">chair</span><span>Furniture</span>
    </a>
    <a href="#" data-src="decor.html" class="nav-btn">
      <span class="material-icons">wallpaper</span><span>Decor</span>
    </a>
    <a href="#" data-src="chat.html" id="bottom-chat" class="nav-btn">
      <span class="material-icons">chat</span><span>Chat</span>
      <span id="chat-badge" class="badge"></span>
    </a>
    <a href="#" id="bottom-cart">
      <img src="ecomassets/Cart.png" alt="Cart"/><span>Cart</span>
      <span id="cart-badge" class="badge"></span>
    </a>
  </nav>

  <script>
    // --- Section Switching ---
    const navButtons = document.querySelectorAll('.nav-btn');
    const iframe     = document.getElementById('view-frame');
    navButtons.forEach(btn => btn.addEventListener('click', e => {
      e.preventDefault();
      navButtons.forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      iframe.src = btn.dataset.src;
      if (btn.dataset.src==='chat.html') {
        document.getElementById('chat-badge').style.display='none';
        document.getElementById('chat-badge').textContent='';
      }
    }));

    // --- Cart Logic ---
    let cart = [];
    function loadCart(){
      cart = JSON.parse(localStorage.getItem('bbf_cart')||'[]');
      updateCartBadge(); renderCart();
    }
    function saveCart(){
      localStorage.setItem('bbf_cart', JSON.stringify(cart));
      updateCartBadge();
    }
    function updateCartBadge(){
      const total = cart.reduce((s,i)=>s+i.qty,0),
            cb    = document.getElementById('cart-badge');
      if(total>0){ cb.textContent=total; cb.style.display='block'; }
      else cb.style.display='none';
    }
    function renderCart(){
      const container = document.getElementById('cart-items');
      let sum=0; container.innerHTML='';
      cart.forEach(item=>{
        sum+=item.price*item.qty;
        container.innerHTML+=`
          <div class="cart-item">
            <img src="${item.img}"/>
            <div class="cart-item-name">#${item.itemNum}</div>
            <div class="quantity-controls">
              <button class="quantity-button minus" data-id="${item.itemNum}">âˆ’</button>
              <div class="quantity-display">${item.qty}</div>
              <button class="quantity-button plus" data-id="${item.itemNum}">+</button>
            </div>
            <div class="cart-item-price">$${(item.price*item.qty).toFixed(2)}</div>
          </div>`;
      });
      document.getElementById('cart-total').textContent = sum.toFixed(2);
      document.querySelectorAll('.quantity-button.plus').forEach(b=>
        b.onclick=()=>{ let it=cart.find(x=>x.itemNum==b.dataset.id); it.qty++; saveCart(); renderCart(); });
      document.querySelectorAll('.quantity-button.minus').forEach(b=>
        b.onclick=()=>{ let idx=cart.findIndex(x=>x.itemNum==b.dataset.id);
                       if(idx>-1){ cart[idx].qty--; if(cart[idx].qty<1) cart.splice(idx,1);
                       saveCart(); renderCart(); }});
    }

    document.getElementById('bottom-cart').addEventListener('click',e=>{
      e.preventDefault(); e.stopPropagation();
      const pop = document.getElementById('cart-popover');
      pop.style.display = pop.style.display==='block'?'none':'block';
    });
    document.getElementById('cart-popover').addEventListener('click',e=>e.stopPropagation());
    document.addEventListener('click',()=>{ 
      const pop = document.getElementById('cart-popover');
      if(pop.style.display==='block') pop.style.display='none';
    });
    document.getElementById('checkout-btn').onclick = ()=> alert('Proceed to checkout');
    window.addEventListener('storage', loadCart);
    loadCart();

    // --- Firebase Chat Badge ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZ5Kmh9XjZKYGJBbEL6qUR3QsPpXY8K1o",
      authDomain: "beaverbuiltchat.firebaseapp.com",
      databaseURL: "https://beaverbuiltchat-default-rtdb.firebaseio.com",
      projectId: "beaverbuiltchat",
      storageBucket: "beaverbuiltchat.appspot.com",
      messagingSenderId: "785578451247",
      appId: "1:785578451247:web:30d2422f3b318032c9c1da",
      measurementId: "G-XT02YCCFYM"
    };
    firebase.initializeApp(firebaseConfig);
    const db       = firebase.database(),
          cbadge   = document.getElementById('chat-badge'),
          vUid     = localStorage.getItem('visitorUid'),
          vName    = localStorage.getItem('visitorName');

    if(vUid && vName){
      let initial=true;
      const tref = db.ref('threads/'+vUid);
      tref.once('value',()=>initial=false);
      tref.on('child_added',snap=>{
        const m=snap.val();
        if(initial||m.system||m.sender===vName) return;
        const cur = parseInt(cbadge.textContent||'0',10)+1;
        cbadge.textContent = cur;
        cbadge.style.display = 'block';
      });

      document.getElementById('bottom-chat').addEventListener('click',()=>{
        cbadge.style.display='none';
        cbadge.textContent='';
      });
    }
  </script>
</body>
</html>
