<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #fafafa; }
    .dashboard-card { background: #fff; border-radius: 1rem; box-shadow: 0 2px 16px #0001; }
    .pending-badge { background: #fef9c3; color: #b45309; border: 1px solid #facc15; border-radius: 4px; font-size: 0.85rem; padding: 2px 8px; }
    .modal-bg { position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(31,41,55,0.7);}
    .modal { background:#fff; border-radius:1.2rem; max-width:96vw; width:420px; box-shadow:0 8px 32px #0002; padding:2rem 2rem 1.2rem 2rem; position:relative;}
    .modal .close-modal { position:absolute;top:8px;right:18px;cursor:pointer;font-size:1.7rem;color:#e11d48;font-weight:700;}
    .modal .close-modal:hover { color:#b91c1c; }
    .receipt-link { color: #06b6d4; text-decoration: underline; cursor: pointer;}
    .paid-badge { background: #bbf7d0; color: #166534; border-radius: 4px; font-size: 0.85rem; padding: 2px 8px;}
    .unpaid-badge { background: #fecaca; color: #b91c1c; border-radius: 4px; font-size: 0.85rem; padding: 2px 8px;}
  </style>
</head>
<body class="h-screen flex flex-col">

  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Enter Admin PIN</h2>
      <input id="admin-pin" type="password" maxlength="4" placeholder="4-digit PIN" class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-pink-300">
      <button id="login-btn" class="w-full bg-gray-200 text-black py-4 rounded-lg hover:bg-gray-300">Login</button>
      <p id="pin-error" class="text-red-600 mt-2"></p>
    </div>
  </div>

  <!-- Main Layout -->
  <div id="main" class="hidden flex-1 flex flex-col">
    <header class="bg-white shadow-md">
      <div class="px-4 py-3 flex items-center">
        <h2 class="text-xl font-semibold text-gray-900">Admin</h2>
      </div>
    </header>
    <main class="flex-1 max-w-3xl w-full mx-auto p-6 space-y-10">
      <!-- Dashboard Stats -->
      <section>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="dashboard-card p-6">
            <p class="text-sm text-gray-500">Total Customers</p>
            <p id="customersCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="dashboard-card p-6">
            <p class="text-sm text-gray-500">Outstanding Invoices</p>
            <p id="outstandingCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="dashboard-card p-6">
            <p class="text-sm text-gray-500">Unpaid Amount Due</p>
            <p id="unpaidAmount" class="text-3xl font-bold">$0.00</p>
          </div>
          <div class="dashboard-card p-6">
            <p class="text-sm text-gray-500">Revenue This Month</p>
            <p id="revenueCount" class="text-3xl font-bold">$0.00</p>
          </div>
        </div>
      </section>

      <!-- Pending Manual Payments -->
      <section>
        <h3 class="text-lg font-bold mb-4">Pending Manual Payments</h3>
        <div id="pending-list" class="space-y-4"></div>
      </section>

      <!-- All Customers & Invoices -->
      <section>
        <h3 class="text-lg font-bold mb-4">All Customers</h3>
        <div id="all-customers-list" class="space-y-8"></div>
      </section>
    </main>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal-bg" class="modal-bg" style="display:none;">
    <div class="modal">
      <div class="close-modal" id="close-confirm-modal">&times;</div>
      <h4 class="text-lg font-bold mb-3" id="confirm-modal-title"></h4>
      <div id="confirm-modal-msg" class="mb-4 text-gray-800"></div>
      <div class="flex gap-4 justify-end">
        <button id="confirm-modal-no" class="bg-gray-200 hover:bg-gray-300 text-black rounded px-4 py-2 font-semibold">Cancel</button>
        <button id="confirm-modal-yes" class="bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2 font-semibold">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // DEMO DATA (sync with customer.html for testing)
    function getCustomers() {
      return JSON.parse(localStorage.getItem('customers') || '[]');
    }
    function getBills() {
      return JSON.parse(localStorage.getItem('bills') || '[]');
    }
    function saveCustomers(cs) {
      localStorage.setItem('customers', JSON.stringify(cs));
    }
    function saveBills(bs) {
      localStorage.setItem('bills', JSON.stringify(bs));
    }

    // Login
    const loginOverlay = document.getElementById('login-overlay');
    const loginBtn = document.getElementById('login-btn');
    const adminPin = document.getElementById('admin-pin');
    const pinError = document.getElementById('pin-error');
    const main = document.getElementById('main');

    loginBtn.onclick = function() {
      pinError.textContent = '';
      if (adminPin.value.trim() === '1234') {
        loginOverlay.classList.add('hidden');
        main.classList.remove('hidden');
        renderDashboard();
      } else {
        pinError.textContent = 'Invalid PIN';
      }
    };

    // Confirm modal logic
    const confirmModalBg = document.getElementById('confirm-modal-bg');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalMsg = document.getElementById('confirm-modal-msg');
    const confirmModalYes = document.getElementById('confirm-modal-yes');
    const confirmModalNo = document.getElementById('confirm-modal-no');
    const closeConfirmModal = document.getElementById('close-confirm-modal');
    let confirmAction = null;

    function showConfirmModal(title, msg, yesAction) {
      confirmModalTitle.textContent = title;
      confirmModalMsg.textContent = msg;
      confirmModalBg.style.display = 'flex';
      confirmAction = yesAction;
    }
    confirmModalYes.onclick = function() {
      if (confirmAction) confirmAction();
      confirmModalBg.style.display = 'none';
    };
    confirmModalNo.onclick = function() {
      confirmModalBg.style.display = 'none';
    };
    closeConfirmModal.onclick = function() {
      confirmModalBg.style.display = 'none';
    };

    // Dashboard rendering
    function renderDashboard() {
      updateMetrics();
      renderPendingManuals();
      renderAllCustomers();
    }

    function updateMetrics() {
      var cs = getCustomers(), bs = getBills();
      document.getElementById('customersCount').textContent = cs.length;
      document.getElementById('outstandingCount').textContent = bs.filter(b => !b.paid && !b.status).length;
      var unpaid = bs.filter(b => !b.paid && !b.status).reduce((sum, b) => sum + Number(b.amount || 0), 0);
      document.getElementById('unpaidAmount').textContent = '$'+unpaid.toFixed(2);
      var start=new Date(); start.setDate(1); start.setHours(0,0,0,0);
      document.getElementById('revenueCount').textContent='$'+bs.filter(b => b.paid&&new Date(b.confirmedAt||b.createdAt)>=start).reduce((s,b)=>s+b.amount,0).toFixed(2);
    }

    // Pending manual payments
    function renderPendingManuals() {
      const pendingList = document.getElementById('pending-list');
      pendingList.innerHTML = '';
      const bills = getBills();
      const cs = getCustomers();
      let pending = bills.filter(b => b.status === "pending");
      if (!pending.length) {
        pendingList.innerHTML = `<div class="dashboard-card p-4 text-gray-500">No pending manual payments.</div>`;
        return;
      }
      pending.forEach((bill, idx) => {
        const cust = cs.find(c => c.id === bill.customerId);
        let div = document.createElement('div');
        div.className = 'dashboard-card p-4 flex flex-col gap-2 border-l-4 border-yellow-400';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <span>
              <b>Customer:</b> ${cust ? cust.name : bill.customerId} <span class="text-xs text-gray-400">ID: ${bill.customerId}</span>
            </span>
            <span class="pending-badge">Pending Manual</span>
          </div>
          <div><b>Invoice Amount:</b> $${bill.amount}</div>
          <div><b>Due:</b> ${bill.dueDate}</div>
          <div><b>Method:</b> ${bill.paymentMethod}</div>
          ${bill.manualNote ? `<div><b>Note:</b> ${bill.manualNote}</div>` : ''}
        `;
        // Confirm/Reject
        let row = document.createElement('div');
        row.className = "flex gap-3 mt-2";
        let confirmBtn = document.createElement('button');
        confirmBtn.textContent = "Confirm Payment";
        confirmBtn.className = "rounded bg-green-600 hover:bg-green-700 text-white px-4 py-2 font-semibold";
        confirmBtn.onclick = function() {
          showConfirmModal(
            "Confirm Manual Payment?",
            `Confirm that invoice for $${bill.amount} paid by ${cust ? cust.name : bill.customerId} (${bill.paymentMethod}) has been received?`,
            function() {
              bill.paid = true;
              bill.status = undefined;
              bill.confirmedAt = (new Date()).toISOString().slice(0,16).replace('T',' ');
              saveBills(bills);
              renderDashboard();
            }
          );
        };
        let rejectBtn = document.createElement('button');
        rejectBtn.textContent = "Reject";
        rejectBtn.className = "rounded bg-red-500 hover:bg-red-600 text-white px-4 py-2 font-semibold";
        rejectBtn.onclick = function() {
          showConfirmModal(
            "Reject Manual Payment?",
            `Reject this manual payment? The customer will see invoice as unpaid again.`,
            function() {
              bill.status = undefined;
              bill.paymentMethod = undefined;
              bill.manualNote = undefined;
              saveBills(bills);
              renderDashboard();
            }
          );
        };
        row.appendChild(confirmBtn);
        row.appendChild(rejectBtn);
        div.appendChild(row);
        pendingList.appendChild(div);
      });
    }

    // All customers & invoices
    function renderAllCustomers() {
      const list = document.getElementById('all-customers-list');
      list.innerHTML = '';
      const cs = getCustomers();
      const bills = getBills();
      if (!cs.length) {
        list.innerHTML = `<div class="dashboard-card p-4 text-gray-500">No customers found.</div>`;
        return;
      }
      cs.forEach(c => {
        let div = document.createElement('div');
        div.className = 'dashboard-card p-6';
        div.innerHTML = `<div class="font-bold mb-1">${c.name} <span class="text-xs text-gray-500">(ID: ${c.id})</span></div>
          <div class="text-gray-700 mb-2">Email: ${c.email || "-"} | Phone: ${c.phone || "-"}</div>`;
        // Invoices
        let billList = document.createElement('div');
        billList.className = "flex flex-col gap-1";
        let customerBills = bills.filter(b => b.customerId === c.id);
        if (!customerBills.length) {
          billList.innerHTML = `<div class="text-gray-400 text-sm">No invoices.</div>`;
        } else {
          customerBills.forEach((b, idx) => {
            let badge = b.status === "pending"
              ? '<span class="pending-badge ml-2">Pending</span>'
              : b.paid
              ? '<span class="paid-badge ml-2">Paid</span>'
              : '<span class="unpaid-badge ml-2">Unpaid</span>';
            billList.innerHTML += `<div>
              <span class="font-semibold">Invoice #${idx + 1}:</span>
              <span>$${b.amount} — Due: ${b.dueDate}</span>
              ${b.paymentMethod ? `<span class="ml-2 text-gray-700 text-xs">(${b.paymentMethod}${b.manualNote ? ": "+b.manualNote : ""})</span>` : ""}
              ${b.confirmedAt ? `<span class="ml-2 text-gray-600 text-xs">Confirmed: ${b.confirmedAt}</span>` : ""}
              ${badge}
            </div>`;
          });
        }
        div.appendChild(billList);
        list.appendChild(div);
      });
    }

    // Autofill demo data if empty (same as customer.html)
    (function demoAutofill() {
      let cs = getCustomers();
      if (!cs.length) {
        cs = [
          { id:"1", name:"John Doe", email:"john@email.com", phone:"123-456-7890", address:"123 Main St", pin:"1234" },
          { id:"2", name:"Jane Smith", email:"jane@email.com", phone:"555-555-5555", address:"456 Elm St", pin:"4321" }
        ];
        saveCustomers(cs);
        saveBills([
          { customerId:"1", amount:120, dueDate:"2025-06-30", paid:false, createdAt:"2025-06-15T12:00:00Z" },
          { customerId:"1", amount:75, dueDate:"2025-05-15", paid:true, createdAt:"2025-05-01T12:00:00Z" },
          { customerId:"2", amount:99, dueDate:"2025-06-29", paid:false, createdAt:"2025-06-12T12:00:00Z" }
        ]);
      }
    })();

  </script>
</body>
</html>
