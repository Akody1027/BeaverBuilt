<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* All your original CSS is untouched, paste your styles here */
    #invoice-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: .5rem; }
    .grid-cell { aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border:1px solid #CBD5E0; border-radius:.25rem; background:#fff; color:#1A202C; font-size:.9rem; cursor:pointer; transition:box-shadow .12s; position: relative;}
    .grid-cell.unpaid { background:#fecaca; border-color:#fecaca; color:#b91c1c;}
    .grid-cell.paid { background:#bbf7d0; border-color:#bbf7d0; color:#166534;}
    .grid-cell.selected { outline: 3px solid #000; z-index:2;}
    .customer-warning {display: inline-flex; align-items: center; margin-left: 0.5rem; background: #f87171; color: #fff; border-radius: 50%; width: 1.1em; height: 1.1em; justify-content: center; font-size: 0.8em; box-shadow: 0 0 2px #b91c1c88;}
    .customer-btn.active, #sidebar .customer-btn.active {background: #E5E7EB !important;border-radius: .375rem;}
    .update-fields { margin-top: 1rem; }
    .update-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;}
    #batch-bar { display:none; position:relative; margin-top:1rem; background:#f3f4f6; border:2px solid #000; border-radius: .5rem; padding:1rem; box-shadow:0 4px 24px #3332; text-align:center; font-weight:600; color:#333; z-index:30; align-items:center; justify-content:center; flex-direction:column;}
    #batch-bar.show { display:flex; }
    #batch-bar .bar-actions {display:flex; gap:1.5rem; justify-content:center;}
    #batch-bar .bar-actions button {min-width:120px;}
    #sidebar { width: auto !important; min-width: 0; max-width: 240px; padding-right: 18px !important; padding-left: 13px !important;}
    #sidebar .customer-btn { white-space: nowrap;}
    #sidebar h1 { white-space: nowrap;}
    .sidebar-divider {width: 80%; height: 2px; background: #e5e7eb; margin: 12px auto 14px auto; border-radius: 2px;}
    #email-modal-bg, #batch-modal-bg {display: none; position:fixed; inset:0; z-index:1000; background:rgba(31,41,55,0.7); justify-content:center; align-items:center;}
    #email-modal-bg.show, #batch-modal-bg.show { display:flex;}
    #email-modal, #batch-modal {background: #fff; border-radius:1.2rem; max-width: 80vw; width: 80vw; max-height:80vh; min-height:380px; box-shadow: 0 8px 32px #0002; display:flex; flex-direction:column; padding:2rem 2rem 1.2rem 2rem; position:relative; overflow:auto; border:3px solid #000;}
    #email-modal .close-modal, #batch-modal .close-modal {position:absolute; top:12px; right:17px; cursor:pointer; font-size:2rem; font-weight:600; color:#e11d48; line-height:1; transition:color .15s; z-index:2000;}
    #email-modal .close-modal:hover, #batch-modal .close-modal:hover { color:#b91c1c;}
    #email-modal-list, #batch-modal-list { margin-bottom:1.5rem;}
    @media (max-width: 900px) {#email-modal, #batch-modal { padding:1rem; max-width:98vw; width:98vw;}}
    @media (max-width: 500px) {#email-modal, #batch-modal { min-height:220px;}}
    .spinner {display:inline-block; width:1.5em; height:1.5em; vertical-align:middle; border:3px solid #cbd5e1; border-top:3px solid #64748b; border-radius:50%; animation:spin 1s linear infinite; margin: 0 auto;}
    @keyframes spin { 100%{transform:rotate(360deg);}}
    .email-check {color: #22c55e; font-size: 1.15em; margin-left: 5px; vertical-align: middle;}
    .customer-id-label { font-weight: bold; margin-right: 3px;}
    .log-entry { font-size: .92em; color: #475569; margin-bottom: 6px;}
    .log-entry .dt { font-size: .85em; color: #999; margin-left:4px;}
  </style>
</head>
<body class="flex h-screen bg-gray-50">
  <!-- (all your original HTML from previous messages, unchanged) -->
  <!-- ... UI layout skipped for brevity, copy all your page here ... -->

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB2lKzEGU4YWV9-E9XILI3Gy0v80F2hJFc",
    authDomain: "customerportal-3032d.firebaseapp.com",
    projectId: "customerportal-3032d",
    storageBucket: "customerportal-3032d.firebasestorage.app",
    messagingSenderId: "1003504088676",
    appId: "1:1003504088676:web:43453e986312257b2f5171",
    measurementId: "G-CVC0HK0WP8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ----- STORAGE LOGIC -----
  function getEmailLog() {
    try { return JSON.parse(localStorage.getItem('emailLog') || '{}'); }
    catch(e) { return {}; }
  }
  function saveEmailLog(log) {
    try { localStorage.setItem('emailLog', JSON.stringify(log)); }
    catch(e) {}
  }

  // --- FIRESTORE DATA LOAD/SAVE ---
  async function loadCustomers() {
    const snap = await db.collection("customers").get();
    return snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
  }
  async function saveCustomer(cust) {
    return db.collection("customers").doc(cust.id).set(cust);
  }
  async function loadBills() {
    const snap = await db.collection("bills").get();
    return snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
  }
  async function saveBill(bill) {
    if(!bill.id) bill.id = Date.now().toString();
    return db.collection("bills").doc(bill.id).set(bill);
  }

  // --- MAIN APP LOGIC ---
  let customers = [];
  let bills = [];
  let selectedCustomerIds = [];
  let activeCustomer = null;

  async function refreshAll() {
    customers = await loadCustomers();
    bills = await loadBills();
    populateSidebar();
    updateMetrics();
    updateGrid();
  }

  function customerHasMissingInfo(c) {
    return !(c.email && c.email.trim()) || !(c.phone && c.phone.trim()) || !(c.address && c.address.trim());
  }
  function populateSidebar() {
    const sidebarCustomerList = document.getElementById('sidebar-customer-list');
    const emailLog = getEmailLog();
    sidebarCustomerList.innerHTML = '';
    customers.slice().sort((a,b)=>parseInt(a.id)-parseInt(b.id)).forEach(function(c){
      var btn = document.createElement('button');
      btn.className = 'customer-btn w-full text-left px-2 py-1 flex items-center justify-between';
      btn.style.position = "relative";
      var content = `<span><span class="customer-id-label">${c.id} -</span> ${c.name}</span>`;
      if (customerHasMissingInfo(c)) {
        content += `<span class="customer-warning" title="Missing info">!</span>`;
      }
      if (emailLog[c.id]) {
        content += ` <span class="email-check" title="Emailed">&#10003;</span>`;
      }
      btn.innerHTML = content;
      btn.addEventListener('click', function(){
        document.querySelectorAll('.customer-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        openCustomer(c.id);
      });
      var li = document.createElement('li'); li.appendChild(btn);
      sidebarCustomerList.appendChild(li);
    });
  }
  function openCustomer(id) {
    activeCustomer = customers.find(function(c){ return c.id===id; });
    if(!activeCustomer) return;
    ['id','name','email','phone','address','pin'].forEach(function(f){
      const el = document.getElementById('profile-'+f);
      if (el) el.textContent = activeCustomer[f]||'';
    });
    renderBills();
    renderEmailLog();
    document.querySelectorAll('.nav-link').forEach(function(l){ l.classList.remove('active'); });
    document.querySelectorAll('.customer-btn').forEach(function(b){
      if(b.textContent.replace('!','').replace('âœ“','').trim().startsWith(activeCustomer.id + ' -')) b.classList.add('active');
      else b.classList.remove('active');
    });
    showSection('profile');
    updateFieldsDiv.innerHTML = '';
  }
  function renderEmailLog() {
    var logDiv = document.getElementById('profile-email-log');
    logDiv.innerHTML = '';
    var emailLog = getEmailLog();
    if (activeCustomer && emailLog[activeCustomer.id]) {
      logDiv.innerHTML = `<div class="log-entry">Last emailed: <span class="dt">${emailLog[activeCustomer.id]}</span></div>`;
    }
  }
  function renderBills() {
    var listEl = document.getElementById('profile-bills-list');
    if(!activeCustomer || !listEl) return;
    listEl.innerHTML='';
    bills.filter(function(b){ return b.customerId===activeCustomer.id; }).forEach(function(b){
      var li = document.createElement('li');
      li.className = 'p-4 bg-gray-100 rounded';
      li.innerHTML = '<p><strong>Amount:</strong> $'+b.amount+'</p><p><strong>Due:</strong> '+b.dueDate+'</p><p><strong>Status:</strong> '+(b.paid?'Paid':'Unpaid')+'</p>';
      if(!b.paid){
        var payBtn = document.createElement('button');
        payBtn.textContent='Mark Paid';
        payBtn.className='mt-2 bg-green-400 text-white px-3 py-1 rounded';
        payBtn.addEventListener('click',async function(){
          b.paid = true;
          await saveBill(b);
          bills = await loadBills();
          renderBills();
          updateMetrics();
          updateGrid();
        });
        li.appendChild(payBtn);
      }
      listEl.appendChild(li);
    });
  }
  // ---- Metrics, grid, batch logic (all unchanged except data source) ----
  function updateMetrics(){
    document.getElementById('customersCount').textContent = customers.length;
    document.getElementById('outstandingCount').textContent = bills.filter(function(b){ return !b.paid; }).length;
    var unpaid = bills.filter(function(b){ return !b.paid; }).reduce(function(sum, b){
      return sum + Number(b.amount || 0);
    }, 0);
    document.getElementById('unpaidAmount').textContent = '$'+unpaid.toFixed(2);
    var start=new Date(); start.setDate(1); start.setHours(0,0,0,0);
    document.getElementById('revenueCount').textContent='$'+bills.filter(function(b){ return b.paid&&new Date(b.createdAt)>=start; }).reduce(function(s,b){ return s+b.amount; },0).toFixed(2);
  }
  function updateGrid(){
    var grid=document.getElementById('invoice-grid'); grid.innerHTML='';
    customers.slice().sort((a,b)=>parseInt(a.id)-parseInt(b.id)).forEach(function(c){
      var cell=document.createElement('div');
      cell.className='grid-cell';
      cell.textContent=c.id;
      var cbills=bills.filter(function(b){ return b.customerId===c.id; });
      if(cbills.some(function(b){ return !b.paid; })) {
        cell.classList.add('unpaid');
      } else {
        cell.classList.add('paid');
      }
      if (selectedCustomerIds.includes(c.id)) cell.classList.add('selected');
      cell.addEventListener('click', function(e) {
        e.preventDefault();
        if (selectedCustomerIds.includes(c.id)) {
          selectedCustomerIds = selectedCustomerIds.filter(cid => cid !== c.id);
        } else {
          selectedCustomerIds.push(c.id);
        }
        updateGrid();
        updateBatchBar();
      });
      grid.appendChild(cell);
    });
    updateBatchBar();
  }
  function showSection(id) {
    ['dashboard','customers','profile'].forEach(function(sec){
      document.getElementById(sec).style.display = (sec===id?'block':'none');
    });
    document.getElementById('page-title').textContent = id.charAt(0).toUpperCase()+id.slice(1);
    if(id!=='profile') document.querySelectorAll('.customer-btn').forEach(function(b){ b.classList.remove('active'); });
  }
  function updateBatchBar() {
    var batchBar = document.getElementById('batch-bar');
    var batchCount = document.getElementById('batch-count');
    if (selectedCustomerIds.length > 0) {
      batchBar.classList.add('show');
      batchCount.textContent = selectedCustomerIds.length;
    } else {
      batchBar.classList.remove('show');
      batchCount.textContent = '0';
    }
  }

  // ------ ADD/EDIT/DELETE ---------
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('login-btn').addEventListener('click', async function(){
      const pinInput = document.getElementById('admin-pin');
      const pinError = document.getElementById('pin-error');
      pinError.textContent = '';
      if(pinInput.value==='1234'){
        document.getElementById('login-btn-text').classList.add('hidden');
        document.getElementById('login-btn-spinner').classList.remove('hidden');
        document.getElementById('login-btn').disabled = true;
        setTimeout(async function(){
          document.getElementById('login-overlay').style.display='none';
          document.getElementById('sidebar').style.display='flex';
          document.getElementById('main').style.display='flex';
          await refreshAll();
          document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');
          showSection('dashboard');
          document.getElementById('login-btn-text').classList.remove('hidden');
          document.getElementById('login-btn-spinner').classList.add('hidden');
          document.getElementById('login-btn').disabled = false;
          pinInput.value = '';
        }, 1200);
      } else {
        pinError.textContent = 'Invalid PIN';
      }
    });

    // Sidebar nav
    navLinks.forEach(function(link){
      link.addEventListener('click', function(e){
        e.preventDefault();
        navLinks.forEach(function(l){ l.classList.remove('active'); });
        link.classList.add('active');
        showSection(link.getAttribute('data-target'));
      });
    });

    // Add Customer
    addCustBtn.addEventListener('click', async function(){
      var id = document.getElementById('cust-id').value.trim();
      var name = document.getElementById('cust-name').value.trim();
      var email = document.getElementById('cust-email').value.trim();
      var phone = document.getElementById('cust-phone').value.trim();
      var address = document.getElementById('cust-address').value.trim();
      if(!id||!name){ alert('ID and name required'); return; }
      var pin = String(Math.floor(1000 + Math.random() * 9000));
      var cust = { id, name, email, phone, address, pin };
      await saveCustomer(cust);
      await refreshAll();
      ['cust-id','cust-name','cust-email','cust-phone','cust-address'].forEach(function(f){ document.getElementById(f).value=''; });
      document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');
      showSection('dashboard');
    });

    // Add Invoice
    addInvoiceBtn.addEventListener('click', async function(){
      if(!activeCustomer){ alert('Select a customer'); return; }
      var amt = document.getElementById('invoice-amount').value.trim();
      if(!amt){ alert('Enter amount'); return; }
      var due = new Date().toISOString().substring(0,10);
      var bill = { customerId:activeCustomer.id, amount:parseFloat(amt), dueDate:due, paid:false, createdAt:new Date().toISOString() };
      await saveBill(bill);
      bills = await loadBills();
      renderBills();
      updateMetrics();
      updateGrid();
      document.getElementById('invoice-amount').value='';
    });

    // Delete Customer
    deleteCustBtn.addEventListener('click', async function(){
      if(!activeCustomer){ alert('Please select a customer first.'); return; }
      if(!confirm('Delete customer "'+activeCustomer.name+'" and all their invoices?')) return;
      await db.collection("customers").doc(activeCustomer.id).delete();
      const delBills = await db.collection("bills").where("customerId", "==", activeCustomer.id).get();
      const batch = db.batch();
      delBills.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      await refreshAll();
      activeCustomer=null;
      document.querySelectorAll('.customer-btn').forEach(function(b){ b.classList.remove('active'); });
      ['profile-id','profile-name','profile-email','profile-phone','profile-address','profile-pin'].forEach(function(f){ document.getElementById(f).textContent=''; });
      document.getElementById('profile-bills-list').innerHTML='';
      updateFieldsDiv.innerHTML = '';
      showSection('dashboard');
      document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');
    });

    // Update customer info fields
    updateCustBtn.addEventListener('click', function() {
      if (updateFieldsDiv.innerHTML !== '') {
        updateFieldsDiv.innerHTML = '';
        return;
      }
      if (!activeCustomer) return;
      const fields = [
        { key: 'email', label: 'Email', type: 'email' },
        { key: 'phone', label: 'Phone Number', type: 'tel' },
        { key: 'address', label: 'Address', type: 'text' }
      ];
      const missing = fields.filter(f => !activeCustomer[f.key] || !activeCustomer[f.key].trim());
      if (!missing.length) {
        updateFieldsDiv.innerHTML = '<div class="text-green-700 mt-2">No missing information!</div>';
        return;
      }
      updateFieldsDiv.innerHTML = '';
      missing.forEach(f => {
        const row = document.createElement('div');
        row.className = 'update-row';
        const input = document.createElement('input');
        input.type = f.type;
        input.placeholder = f.label;
        input.className = 'border rounded px-2 py-1 flex-1';
        input.style.minWidth = "0";
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add';
        addBtn.className = 'bg-gray-300 hover:bg-gray-400 text-black px-3 py-1 rounded ml-2';
        addBtn.onclick = async function() {
          const val = input.value.trim();
          if (!val) { input.classList.add('border-red-400'); return; }
          activeCustomer[f.key] = val;
          await saveCustomer(activeCustomer);
          customers = await loadCustomers();
          openCustomer(activeCustomer.id);
          updateFieldsDiv.removeChild(row);
          populateSidebar();
          updateMetrics();
          updateGrid();
          const remaining = fields.filter(ff => !activeCustomer[ff.key] || !activeCustomer[ff.key].trim());
          if (remaining.length === 0) {
            updateFieldsDiv.innerHTML = '<div class="text-green-700 mt-2">All information updated!</div>';
            setTimeout(() => updateFieldsDiv.innerHTML = '', 2000);
          }
        };
        row.appendChild(input);
        row.appendChild(addBtn);
        updateFieldsDiv.appendChild(row);
      });
    });

    // Mass Email Form with checkmark disappear
    document.getElementById('mass-email-form').addEventListener('submit', function(e){
      e.preventDefault();
      let emailLog = getEmailLog();
      let now = new Date();
      selectedCustomerIds.forEach(function(cid) {
        emailLog[cid] = now.toLocaleString();
        setTimeout(function() {
          let curLog = getEmailLog();
          if (curLog[cid]) {
            delete curLog[cid];
            saveEmailLog(curLog);
            populateSidebar();
            if (activeCustomer && activeCustomer.id === cid) renderEmailLog();
          }
        }, 5000);
      });
      saveEmailLog(emailLog);
      populateSidebar();
      if (activeCustomer) renderEmailLog();
      document.getElementById('email-modal-feedback').textContent = `Emails sent to ${selectedCustomerIds.length} customer(s)!`;
      setTimeout(()=>{ document.getElementById('email-modal-bg').classList.remove('show'); }, 1300);
    });

    // Show Add Customer section
    addCustIcon.addEventListener('click',function(){
      navLinks.forEach(function(l){ l.classList.remove('active'); });
      showSection('customers');
    });

    // Initial load
    // Hide main UI until logged in
    document.getElementById('main').style.display = 'none';
    document.getElementById('sidebar').style.display = 'none';
  });
</script>
</body>
</html>
