<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Portal</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js"></script>
  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --accent: #ffcccc; }
    .btn-accent { @apply bg-[var(--accent)] hover:bg-red-200 transition-transform hover:scale-105; }
    .card { @apply bg-white p-6 rounded-2xl shadow-lg hover:shadow-2xl transition-shadow; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Sticky Header -->
  <header class="bg-white shadow-md sticky top-0 z-20">
    <div class="max-w-3xl mx-auto px-6 py-4">
      <h1 class="text-3xl font-bold text-gray-800">Admin</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-3xl mx-auto px-6 py-8 space-y-8">

    <!-- 1) PIN Entry -->
    <section id="pin-section" class="card">
      <h2 class="text-2xl font-semibold mb-6">Enter Admin PIN</h2>
      <input id="admin-pin" type="password" maxlength="4"
             class="w-full p-4 border-2 rounded-lg mb-6 text-xl focus:outline-none focus:border-[var(--accent)]"
             placeholder="4-digit PIN" />
      <button id="pin-submit"
              class="btn-accent text-white w-full py-4 rounded-lg text-lg font-medium">
        Login
      </button>
      <p id="pin-error" class="text-red-600 mt-4"></p>
    </section>

    <!-- 2) Admin Interface -->
    <section id="admin-section" class="hidden space-y-8">

      <!-- Add Customer -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">+ Add Customer</h2>
        <input id="cust-name" type="text"
               class="w-full p-4 border rounded-lg mb-4 text-lg"
               placeholder="Customer Name" />
        <input id="cust-email" type="email"
               class="w-full p-4 border rounded-lg mb-4 text-lg"
               placeholder="Customer Email" />
        <button id="add-cust-btn"
                class="btn-accent text-white px-6 py-4 rounded-lg text-lg font-medium">
          Add Customer
        </button>
      </div>

      <!-- Customer List -->
      <div id="customers-list" class="space-y-4"></div>

      <!-- Send All New Bills -->
      <button id="send-all-btn"
              class="btn-accent text-white w-full py-4 rounded-lg text-lg font-medium">
        Send All New Bills
      </button>

    </section>
  </main>

  <!-- Firebase & App Logic -->
  <script>
    // *** CONFIGURE ***
    const ADMIN_PIN = "1234";  // ← your 4-digit PIN
    const firebaseConfig = {
      // your firebaseConfig here
    };
    // ******************

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const functions = firebase.app().functions('us-central1');

    // UI refs
    const pinSection   = document.getElementById('pin-section');
    const adminSection = document.getElementById('admin-section');
    const pinError     = document.getElementById('pin-error');

    // 1) Admin PIN check
    document.getElementById('pin-submit').onclick = () => {
      if (document.getElementById('admin-pin').value === ADMIN_PIN) {
        pinSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        loadCustomers();
      } else {
        pinError.textContent = 'Invalid PIN. Please try again.';
      }
    };

    // 2) Load & render customers
    async function loadCustomers() {
      const listDiv = document.getElementById('customers-list');
      listDiv.innerHTML = '';
      const snap = await db.collection('customers').orderBy('createdAt').get();
      snap.forEach(doc => {
        const data = doc.data();
        const card = document.createElement('div');
        card.className = 'card flex justify-between items-center';
        card.innerHTML = `
          <div>
            <p class="font-semibold text-lg">${data.name}</p>
            <p class="text-gray-600">${data.email}</p>
            <p class="text-sm">PIN: <span class="font-mono">${data.pin}</span></p>
          </div>
          <button class="btn-accent text-white px-5 py-3 rounded-lg text-base font-medium"
                  onclick="addBill('${doc.id}','${data.name}')">
            Add Bill
          </button>
        `;
        listDiv.appendChild(card);
      });
    }

    // 3) Add customer
    document.getElementById('add-cust-btn').onclick = async () => {
      const name  = document.getElementById('cust-name').value.trim();
      const email = document.getElementById('cust-email').value.trim();
      if (!name || !email) {
        return alert('Please enter both name and email.');
      }
      // generate unique 4-digit PIN
      let pin;
      do {
        pin = Math.floor(1000 + Math.random() * 9000).toString();
        const exists = await db.collection('customers').where('pin','==',pin).get();
        if (exists.empty) break;
      } while(true);

      await db.collection('customers').add({
        name, email, pin,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('cust-name').value = '';
      document.getElementById('cust-email').value = '';
      loadCustomers();
    };

    // 4) Add Bill for a customer
    async function addBill(custId, custName) {
      const amount = prompt(`Amount for ${custName}:`);
      if (!amount) return;
      const desc  = prompt('Description (optional):','');
      const due   = prompt('Due Date (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
      // invoice number
      const prefix = new Date().toISOString().slice(0,10).replace(/-/g,'');
      const todayBills = await db.collection('bills')
        .where('invoiceNumber','>=', prefix)
        .where('invoiceNumber','<', (parseInt(prefix)+1).toString())
        .get();
      const index = todayBills.size + 1;
      const invoiceNumber = `${prefix}-${String(index).padStart(3,'0')}`;

      await db.collection('bills').add({
        customerId: custId,
        invoiceNumber,
        dueDate: due,
        amount: parseFloat(amount),
        description: desc,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        sent: false,
        paid: false
      });
      alert(`Created invoice ${invoiceNumber}`);
    }

    // 5) Send all new bills
    document.getElementById('send-all-btn').onclick = async () => {
      const billsSnap = await db.collection('bills').where('sent','==',false).get();
      if (billsSnap.empty) return alert('No new bills to send.');
      if (!confirm(`Send ${billsSnap.size} emails now?`)) return;

      // build payload
      const payload = [];
      for (let doc of billsSnap.docs) {
        const b = doc.data();
        const cust = await db.collection('customers').doc(b.customerId).get();
        payload.push({
          id: doc.id,
          email: cust.data().email,
          invoiceNumber: b.invoiceNumber,
          link: `${location.origin}/checkout.html?pin=${cust.data().pin}`
        });
      }

      // call Cloud Function
      const sendFn = functions.httpsCallable('sendNewBills');
      await sendFn({ bills: payload });

      // mark sent
      const batch = db.batch();
      billsSnap.docs.forEach(doc => batch.update(doc.ref, { sent: true }));
      await batch.commit();

      alert('All emails sent successfully.');
    };
  </script>
</body>
</html>
