<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- your original styles --- */
    #invoice-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: .5rem; }
    .grid-cell {
      aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
      border:1px solid #CBD5E0; border-radius:.25rem; background:#fff;
      color:#1A202C; font-size:.9rem; cursor:pointer; transition:box-shadow .12s;
      position: relative;
    }
    .grid-cell.unpaid { background:#fecaca; border-color:#fecaca; color:#b91c1c; }
    .grid-cell.paid   { background:#bbf7d0; border-color:#bbf7d0; color:#166534; }
    .grid-cell.selected { outline: 3px solid #000; z-index:2; }
    .customer-warning {
      display: inline-flex; align-items: center; margin-left: 0.5rem;
      background: #f87171; color: #fff; border-radius: 50%; width: 1.1em; height: 1.1em;
      justify-content: center; font-size: 0.8em; box-shadow: 0 0 2px #b91c1c88;
    }
    .customer-btn.active, #sidebar .customer-btn.active {
      background: #E5E7EB !important;
      border-radius: .375rem;
    }
    .customer-pending {
      background: #fde68a !important;
      color: #b45309 !important;
      border-radius: 50%;
      width: 1.1em; height: 1.1em; display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.9em; margin-left: 5px; border: 1px solid #b45309;
    }
    /* (rest of your styles remain unchanged) */
  </style>
</head>
<body class="flex h-screen bg-gray-50">
  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Admin Login</h2>
      <input id="admin-pin" type="password" maxlength="4" placeholder="4-digit PIN" class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-gray-300">
      <button id="login-btn" class="w-full py-4 bg-gray-200 text-black rounded-lg hover:bg-gray-300 flex justify-center items-center text-lg font-semibold transition">
        <span id="login-btn-text">Login</span>
        <span id="login-btn-spinner" class="spinner hidden"></span>
      </button>
      <p id="pin-error" class="mt-2 text-red-600"></p>
    </div>
  </div>
  <!-- Email Modal, Batch Modal, Sidebar, Main Content ... -->
  <!-- ...all your original HTML... -->

  <!-- Sidebar -->
  <nav id="sidebar" class="hidden flex-shrink-0 flex-col bg-white p-4 shadow-lg">
    <h1 class="mb-4 text-2xl font-bold">Admin</h1>
    <button data-target="dashboard" class="nav-link mb-2 flex w-full items-center rounded px-2 py-1 text-left text-gray-700 hover:bg-gray-100">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9.75L12 4.5l9 5.25V21a.75.75 0 01-.75.75H3.75A.75.75 0 013 21V9.75z"/></svg>Dashboard
    </button>
    <div class="sidebar-divider"></div>
    <div class="mb-2 flex items-center">
      <span class="text-gray-700">ðŸ‘¥ Customers</span>
      <button id="add-cust-icon" class="ml-2 rounded bg-gray-200 px-2 py-1">+</button>
    </div>
    <ul id="sidebar-customer-list" class="space-y-1 text-gray-600"></ul>
  </nav>

  <!-- Main Content -->
  <div id="main" class="hidden flex flex-1 flex-col">
    <header class="bg-white shadow-md">
      <div class="px-4 py-3"><h2 id="page-title" class="text-xl font-semibold">Dashboard</h2></div>
    </header>
    <main class="mx-auto flex-1 max-w-4xl overflow-auto p-6 space-y-6 w-full">
      <!-- Dashboard -->
      <section id="dashboard" class="space-y-6">
        <!-- ... your dashboard code unchanged ... -->
      </section>
      <!-- Add Customer -->
      <section id="customers" class="hidden space-y-8">
        <!-- ... your add customer code unchanged ... -->
      </section>
      <!-- Profile -->
      <section id="profile" class="hidden space-y-6">
        <div class="mx-auto max-w-md space-y-4 rounded-2xl bg-white p-6 shadow">
          <h3 class="text-xl font-semibold">Customer Profile</h3>
          <p><strong>ID:</strong> <span id="profile-id"></span></p>
          <p><strong>Name:</strong> <span id="profile-name"></span></p>
          <p><strong>Email:</strong> <span id="profile-email"></span></p>
          <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
          <p><strong>Address:</strong> <span id="profile-address"></span></p>
          <p><strong>Customer PIN number:</strong> <span id="profile-pin"></span></p>
          <input id="invoice-amount" type="number" placeholder="Invoice Amount" class="mb-2 w-full rounded-lg border p-2">
          <button id="add-invoice-btn" class="w-full rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">Add Invoice</button>
          <ul id="profile-bills-list" class="space-y-2 pt-4"></ul>
          <!-- Manual Payment Review Notification -->
          <div id="manual-payment-review" class="mt-4"></div>
          <div class="flex flex-row gap-2 mt-4">
            <button id="update-cust-btn" class="flex-1 rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">Update</button>
            <button id="delete-cust-btn" class="flex-1 rounded-lg bg-red-500 py-2 text-white hover:bg-red-600">Delete Customer</button>
          </div>
          <div id="update-fields" class="update-fields"></div>
          <div id="profile-email-log" class="mt-4"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- your original script (unchanged up to function declarations) ---
    // Add this manual payment logic at the top of your script
    function getManualPayments() {
      try { return JSON.parse(localStorage.getItem('manualPayments') || '{}'); } catch(e){ return {}; }
    }
    function saveManualPayments(obj) {
      try { localStorage.setItem('manualPayments', JSON.stringify(obj)); } catch(e){}
    }
    // ...all your original functions and variables, unchanged...

    // Replace or update your populateSidebar function with this:
    function populateSidebar(){
      var emailLog = getEmailLog();
      var manualPayments = getManualPayments();
      sidebarCustomerList.innerHTML='';
      getCustomers().slice().sort((a,b)=>parseInt(a.id)-parseInt(b.id)).forEach(function(c){
        var btn = document.createElement('button');
        btn.className = 'customer-btn w-full text-left px-2 py-1 flex items-center justify-between';
        btn.style.position = "relative";
        var content = `<span><span class="customer-id-label">${c.id} -</span> ${c.name}</span>`;
        if (customerHasMissingInfo(c)) {
          content += `<span class="customer-warning" title="Missing info">!</span>`;
        }
        // Yellow ? for pending manual payment review
        let hasPending = Object.values(manualPayments).some(mp => mp.customerId === c.id && mp.status === "pending");
        if (hasPending) {
          content += ` <span class="customer-pending" title="Manual payment to review">?</span>`;
        }
        if (emailLog[c.id]) {
          content += ` <span class="email-check" title="Emailed">&#10003;</span>`;
        }
        btn.innerHTML = content;
        btn.addEventListener('click', function(){
          document.querySelectorAll('.customer-btn').forEach(function(b){ b.classList.remove('active'); });
          btn.classList.add('active');
          openCustomer(c.id);
        });
        var li = document.createElement('li'); li.appendChild(btn);
        sidebarCustomerList.appendChild(li);
      });
    }

    // Add this manual payment review function:
    function renderManualPaymentReview() {
      const div = document.getElementById('manual-payment-review');
      div.innerHTML = "";
      if (!activeCustomer) return;
      let manualPayments = getManualPayments();
      let bills = getBills().filter(b => b.customerId === activeCustomer.id);
      let items = Object.entries(manualPayments)
        .filter(([billId, req]) => req.customerId === activeCustomer.id && req.status === "pending");
      if (items.length === 0) {
        div.innerHTML = "";
        return;
      }
      items.forEach(([billId, req]) => {
        let idx = req.invoiceIndex || bills.findIndex(b => `${b.createdAt}|${b.customerId}|${b.amount}` === billId);
        let bill = bills[idx];
        if (!bill) return;
        let box = document.createElement('div');
        box.className = "rounded bg-yellow-100 border border-yellow-500 p-3 my-2 flex flex-col";
        box.innerHTML = `<div class="font-bold text-yellow-800 mb-1">
          Manual payment review requested for Invoice #${idx+1} (${req.method})
        </div>
        <div><strong>Amount:</strong> $${bill.amount} &nbsp; <strong>Due:</strong> ${bill.dueDate}</div>
        <div class="flex gap-2 mt-2">
          <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded" id="approve-${billId}">Approve</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" id="deny-${billId}">Deny</button>
        </div>
        <div class="text-xs text-gray-500 mt-2">Once approved, invoice is marked as paid and the customer is notified. Deny to reject this payment.</div>
        `;
        div.appendChild(box);

        setTimeout(() => {
          let approveBtn = document.getElementById(`approve-${billId}`);
          let denyBtn = document.getElementById(`deny-${billId}`);
          if (approveBtn) approveBtn.onclick = function(){
            let bs = getBills();
            let targetIdx = bs.findIndex(b => `${b.createdAt}|${b.customerId}|${b.amount}` === billId);
            if (targetIdx !== -1) {
              bs[targetIdx].paid = true;
              saveBills(bs);
            }
            let mps = getManualPayments();
            mps[billId].status = "approved";
            saveManualPayments(mps);
            renderManualPaymentReview();
            renderBills();
            updateMetrics();
            updateGrid();
            populateSidebar();
            window.dispatchEvent(new Event("storage"));
          };
          if (denyBtn) denyBtn.onclick = function(){
            let mps = getManualPayments();
            mps[billId].status = "denied";
            saveManualPayments(mps);
            renderManualPaymentReview();
            window.dispatchEvent(new Event("storage"));
            populateSidebar();
          };
        }, 0);
      });
    }

    // In your openCustomer function, call this:
    function openCustomer(id) {
      activeCustomer = getCustomers().find(function(c){ return c.id===id; });
      if(!activeCustomer) return;
      ['id','name','email','phone','address'].forEach(function(f){
        document.getElementById('profile-'+f).textContent = activeCustomer[f]||'';
      });
      document.getElementById('profile-pin').textContent = activeCustomer.pin || '';
      renderBills();
      renderEmailLog();
      renderManualPaymentReview(); // <-- added here
      document.querySelectorAll('.nav-link').forEach(function(l){ l.classList.remove('active'); });
      document.querySelectorAll('.customer-btn').forEach(function(b){
        if(b.textContent.replace('!','').replace('âœ“','').trim().startsWith(activeCustomer.id + ' -')) b.classList.add('active');
        else b.classList.remove('active');
      });
      showSection('profile');
      updateFieldsDiv.innerHTML = '';
    }

    // Listen for localStorage changes:
    window.addEventListener('storage', function(e){
      if (e.key === "manualPayments") {
        populateSidebar();
        if (activeCustomer) renderManualPaymentReview();
      }
    });

    // ...rest of your admin code unchanged...
  </script>
</body>
</html>
