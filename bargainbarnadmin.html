<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase App & Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    #invoice-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: .5rem; }
    .grid-cell {
      aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
      border:1px solid #CBD5E0; border-radius:.25rem; background:#fff;
      color:#1A202C; font-size:.9rem; cursor:pointer; transition:box-shadow .12s;
      position: relative;
    }
    .grid-cell.unpaid { background:#fecaca; border-color:#fecaca; color:#b91c1c; }
    .grid-cell.paid   { background:#bbf7d0; border-color:#bbf7d0; color:#166534; }
    .grid-cell.selected { outline: 3px solid #000; z-index:2; }
    .customer-warning {
      display: inline-flex; align-items: center; margin-left: .5rem;
      background: #f87171; color: #fff; border-radius: 50%; width:1.1em; height:1.1em;
      justify-content:center; font-size:.8em; box-shadow:0 0 2px #b91c1c88;
    }
    .customer-btn.active { background:#E5E7EB!important; border-radius:.375rem; }
    .update-fields { margin-top:1rem; }
    .update-row { display:flex; align-items:center; gap:.5rem; margin-bottom:.75rem; }
    #batch-bar { display:none; position:relative; margin-top:1rem; background:#f3f4f6;
                 border:2px solid #000; border-radius:.5rem; padding:1rem;
                 box-shadow:0 4px 24px #3332; text-align:center; font-weight:600;
                 color:#333; z-index:30; align-items:center; justify-content:center;
                 flex-direction:column; }
    #batch-bar.show { display:flex; }
    .spinner { display:inline-block; width:1.5em; height:1.5em;
               border:3px solid #cbd5e1; border-top:3px solid #64748b;
               border-radius:50%; animation:spin 1s linear infinite; margin:0 auto; }
    @keyframes spin { 100%{transform:rotate(360deg);} }
    /* Modal, sidebar, etc. styles unchanged from original */
    /* … */
  </style>
</head>
<body class="flex h-screen bg-gray-50">

  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Admin Login</h2>
      <input id="admin-pin" type="password" maxlength="4" placeholder="4-digit PIN"
             class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-gray-300">
      <button id="login-btn"
              class="w-full py-4 bg-gray-200 text-black rounded-lg hover:bg-gray-300 flex justify-center items-center text-lg font-semibold transition">
        <span id="login-btn-text">Login</span>
        <span id="login-btn-spinner" class="spinner hidden"></span>
      </button>
      <p id="pin-error" class="mt-2 text-red-600"></p>
    </div>
  </div>

  <!-- Email Modal -->
  <!-- … (unchanged) … -->

  <!-- Batch Modal -->
  <!-- … (unchanged) … -->

  <!-- Sidebar -->
  <!-- … (unchanged) … -->

  <!-- Main Content -->
  <div id="main" class="hidden flex flex-1 flex-col">
    <header class="bg-white shadow-md"><div class="px-4 py-3"><h2 id="page-title" class="text-xl font-semibold">Dashboard</h2></div></header>
    <main class="mx-auto flex-1 max-w-4xl overflow-auto p-6 space-y-6 w-full">
      <!-- Dashboard Panels -->
      <!-- … (unchanged) … -->

      <!-- Invoice Grid -->
      <div class="rounded-2xl bg-white p-6 shadow">
        <h3 class="mb-4 text-lg font-semibold">Invoice Tracking Calendar</h3>
        <div id="invoice-grid"></div>
        <div id="batch-bar"><!-- … --></div>
      </div>
    </main>

    <!-- Add Customer Section -->
    <!-- … (unchanged) … -->

    <!-- Profile Section -->
    <!-- … (unchanged) … -->
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- INITIALIZE FIREBASE & FIRESTORE ---
    const firebaseConfig = {
      apiKey: "AIzaSyB2lKzEGU4YWV9-E9XILI3Gy0v80F2hJFc",
      authDomain: "customerportal-3032d.firebaseapp.com",
      projectId: "customerportal-3032d",
      storageBucket: "customerportal-3032d.appspot.com",
      messagingSenderId: "1003504088676",
      appId: "1:1003504088676:web:43453e986312257b2f5171",
      measurementId: "G-CVC0HK0WP8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- LOCALSTORAGE CUSTOMER HELPERS (UNCHANGED) ---
    function getCustomers() { /* … unchanged … */ }
    function saveCustomers(c) { /* … unchanged … */ }
    function getEmailLog() { /* … unchanged … */ }
    function saveEmailLog(log) { /* … unchanged … */ }
    function generateUniquePin(existingPins) { /* … unchanged … */ }

    // --- FIRESTORE BILLS HELPERS ---
    async function getBills() {
      const snap = await db.collection('bills').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    function addBill(bill) {
      return db.collection('bills').add(bill);
    }
    function updateBillPaid(billId, paid) {
      return db.collection('bills').doc(billId).update({ paid });
    }

    // --- DOM REFERENCES ---
    const loginOverlay = document.getElementById('login-overlay'),
          loginBtn     = document.getElementById('login-btn'),
          pinInput     = document.getElementById('admin-pin'),
          pinError     = document.getElementById('pin-error'),
          sidebar      = document.getElementById('sidebar'),
          main         = document.getElementById('main'),
          navLinks     = document.querySelectorAll('.nav-link'),
          sidebarList  = document.getElementById('sidebar-customer-list'),
          addCustIcon  = document.getElementById('add-cust-icon'),
          addCustBtn   = document.getElementById('add-cust-btn'),
          addInvoiceBtn = document.getElementById('add-invoice-btn'),
          deleteCustBtn = document.getElementById('delete-cust-btn'),
          updateCustBtn = document.getElementById('update-cust-btn'),
          updateFieldsDiv = document.getElementById('update-fields'),
          batchBar     = document.getElementById('batch-bar'),
          batchPaidBtn = document.getElementById('batch-paid'),
          batchEmailBtn= document.getElementById('batch-email'),
          batchCount   = document.getElementById('batch-count'),
          modalEmailBg = document.getElementById('email-modal-bg'),
          massEmailForm= document.getElementById('mass-email-form'),
          emailSubject = document.getElementById('email-subject'),
          emailBody    = document.getElementById('email-body'),
          emailModalFeedback = document.getElementById('email-modal-feedback'),
          grid         = document.getElementById('invoice-grid'),
          loginSpinnerText = document.getElementById('login-btn-text'),
          loginSpinner   = document.getElementById('login-btn-spinner');

    let selectedCustomerIds = [], activeCustomer = null;

    // --- UTILITY ---
    function toggleLoginSpinner(show) {
      loginSpinnerText.classList.toggle('hidden', show);
      loginSpinner.classList.toggle('hidden', !show);
    }

    // --- SHOW SECTION ---
    function showSection(id) {
      ['dashboard','customers','profile'].forEach(sec => {
        document.getElementById(sec).style.display = (sec === id ? 'block' : 'none');
      });
      document.getElementById('page-title').textContent = id.charAt(0).toUpperCase() + id.slice(1);
      if (id !== 'profile') {
        document.querySelectorAll('.customer-btn').forEach(b => b.classList.remove('active'));
      }
    }

    // --- POPULATE SIDEBAR (CUSTOMERS) ---
    function populateSidebar() {
      const emailLog = getEmailLog();
      sidebarList.innerHTML = '';
      getCustomers().slice().sort((a,b)=>+a.id - +b.id).forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'customer-btn w-full text-left px-2 py-1 flex items-center justify-between';
        let content = `<span><strong>${c.id}</strong> - ${c.name}</span>`;
        if (!c.email || !c.phone || !c.address) {
          content += ` <span class="customer-warning">!</span>`;
        }
        if (emailLog[c.id]) {
          content += ` <span class="email-check">&#10003;</span>`;
        }
        btn.innerHTML = content;
        btn.onclick = () => {
          document.querySelectorAll('.customer-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          openCustomer(c.id);
        };
        const li = document.createElement('li');
        li.appendChild(btn);
        sidebarList.appendChild(li);
      });
    }

    // --- OPEN CUSTOMER PROFILE & BILLS ---
    function openCustomer(id) {
      activeCustomer = getCustomers().find(c=>c.id===id);
      ['id','name','email','phone','address'].forEach(f => {
        document.getElementById('profile-'+f).textContent = activeCustomer[f]||'';
      });
      document.getElementById('profile-pin').textContent = activeCustomer.pin;
      renderBills();
      renderEmailLog();
      showSection('profile');
      updateFieldsDiv.innerHTML = '';
    }

    // --- RENDER EMAIL LOG ---
    function renderEmailLog() {
      const logDiv = document.getElementById('profile-email-log');
      logDiv.innerHTML = '';
      const log = getEmailLog();
      if (activeCustomer && log[activeCustomer.id]) {
        logDiv.innerHTML = `<div>Last emailed: <em>${log[activeCustomer.id]}</em></div>`;
      }
    }

    // --- RENDER BILLS (FROM FIRESTORE) ---
    async function renderBills() {
      const listEl = document.getElementById('profile-bills-list');
      listEl.innerHTML = '';
      if (!activeCustomer) return;
      const bills = await getBills();
      bills.filter(b=>b.customerId===activeCustomer.id).forEach(b => {
        const li = document.createElement('li');
        li.className = 'p-4 bg-gray-100 rounded';
        li.innerHTML = `
          <div><strong>Amount:</strong> $${b.amount}</div>
          <div><strong>Due:</strong> ${b.dueDate}</div>
          <div><strong>Status:</strong> ${b.paid?'Paid':'Unpaid'}</div>
        `;
        if (!b.paid) {
          const btn = document.createElement('button');
          btn.textContent = 'Mark Paid';
          btn.className = 'mt-2 bg-green-400 text-white px-3 py-1 rounded';
          btn.onclick = async () => {
            await updateBillPaid(b.id, true);
            renderBills();
            updateMetrics();
            updateGrid();
          };
          li.appendChild(btn);
        }
        listEl.appendChild(li);
      });
    }

    // --- ADD CUSTOMER ---
    addCustIcon.onclick = () => showSection('customers');
    addCustBtn.onclick = () => {
      const id = document.getElementById('cust-id').value.trim();
      const name = document.getElementById('cust-name').value.trim();
      if (!id || !name) { alert('ID and name required'); return; }
      const cs = getCustomers();
      const pin = generateUniquePin(cs.map(c=>c.pin));
      cs.push({
        id, name,
        email: document.getElementById('cust-email').value.trim(),
        phone: document.getElementById('cust-phone').value.trim(),
        address: document.getElementById('cust-address').value.trim(),
        pin
      });
      saveCustomers(cs);
      populateSidebar(); updateMetrics(); updateGrid();
      showSection('dashboard');
    };

    // --- ADD INVOICE (firestore) ---
    addInvoiceBtn.onclick = async () => {
      if (!activeCustomer) { alert('Select a customer'); return; }
      const amt = document.getElementById('invoice-amount').value.trim();
      if (!amt) { alert('Enter amount'); return; }
      const due = new Date().toISOString().slice(0,10);
      await addBill({
        customerId: activeCustomer.id,
        amount: parseFloat(amt),
        dueDate: due,
        paid: false,
        createdAt: new Date().toISOString()
      });
      document.getElementById('invoice-amount').value = '';
      renderBills();
      updateMetrics();
      updateGrid();
    };

    // --- DELETE CUSTOMER & BILLS ---
    deleteCustBtn.onclick = async () => {
      if (!activeCustomer) { alert('Select a customer'); return; }
      if (!confirm(`Delete "${activeCustomer.name}" and all invoices?`)) return;
      // delete localStorage customer
      saveCustomers(getCustomers().filter(c=>c.id!==activeCustomer.id));
      // delete his bills from Firestore
      const bills = await getBills();
      for(const b of bills.filter(b=>b.customerId===activeCustomer.id)) {
        await db.collection('bills').doc(b.id).delete();
      }
      activeCustomer = null;
      document.querySelectorAll('.customer-btn').forEach(b=>b.classList.remove('active'));
      populateSidebar(); updateMetrics(); updateGrid();
      showSection('dashboard');
    };

    // --- UPDATE CUSTOMER MISSING FIELDS ---
    updateCustBtn.onclick = () => { /* unchanged */ };

    // --- BATCH ACTIONS, EMAIL MODAL, LONG-PRESS, etc. ---
    // (all unchanged except calls to updateMetrics/updateGrid/renderBills now async)
    // …

    // --- METRICS & GRID (FROM FIRESTORE) ---
    async function updateMetrics() {
      const cs = getCustomers();
      const bs = await getBills();
      document.getElementById('customersCount').textContent = cs.length;
      document.getElementById('outstandingCount').textContent = bs.filter(b=>!b.paid).length;
      const unpaid = bs.filter(b=>!b.paid).reduce((s,b)=>s+b.amount,0);
      document.getElementById('unpaidAmount').textContent = '$'+unpaid.toFixed(2);
      const start = new Date(); start.setDate(1); start.setHours(0,0,0,0);
      const rev = bs.filter(b=>b.paid && new Date(b.createdAt)>=start)
                    .reduce((s,b)=>s+b.amount,0);
      document.getElementById('revenueCount').textContent = '$'+rev.toFixed(2);
    }

    async function updateGrid() {
      const gridEl = document.getElementById('invoice-grid');
      gridEl.innerHTML = '';
      const cs = getCustomers().slice().sort((a,b)=>+a.id-+b.id);
      const bs = await getBills();
      cs.forEach(c => {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.textContent = c.id;
        const unpaid = bs.some(b=>b.customerId===c.id && !b.paid);
        cell.classList.add(unpaid?'unpaid':'paid');
        cell.onclick = () => {
          if (selectedCustomerIds.includes(c.id)) {
            selectedCustomerIds = selectedCustomerIds.filter(x=>x!==c.id);
          } else {
            selectedCustomerIds.push(c.id);
          }
          updateGrid();
          // … update batch bar …
        };
        gridEl.appendChild(cell);
      });
      // … update batch bar …
    }

    // --- LOGIN BUTTON ---
    loginBtn.onclick = () => {
      pinError.textContent = '';
      if (pinInput.value==='1234') {
        toggleLoginSpinner(true);
        setTimeout(()=>{
          loginOverlay.style.display='none';
          sidebar.style.display='flex';
          main.style.display='flex';
          populateSidebar();
          updateMetrics();
          updateGrid();
          document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');
          showSection('dashboard');
          toggleLoginSpinner(false);
          pinInput.value = '';
        },2000);
      } else {
        pinError.textContent = 'Invalid PIN';
      }
    };

    // ON LOAD
    populateSidebar();
    updateMetrics();
    updateGrid();
  });
  </script>

</body>
</html>
