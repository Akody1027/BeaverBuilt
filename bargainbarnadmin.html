<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <!-- Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* â€”â€”â€” All original CSS unchanged â€”â€”â€” */
    #invoice-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: .5rem; }
    .grid-cell {
      aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
      border:1px solid #CBD5E0; border-radius:.25rem; background:#fff;
      color:#1A202C; font-size:.9rem; cursor:pointer; transition:box-shadow .12s;
      position: relative;
    }
    .grid-cell.unpaid { background:#fecaca; border-color:#fecaca; color:#b91c1c; }
    .grid-cell.paid   { background:#bbf7d0; border-color:#bbf7d0; color:#166534; }
    .grid-cell.selected { outline: 3px solid #000; z-index:2; }
    .customer-warning {
      display: inline-flex; align-items: center; margin-left: .5rem;
      background: #f87171; color: #fff; border-radius: 50%; width:1.1em; height:1.1em;
      justify-content:center; font-size:.8em; box-shadow:0 0 2px #b91c1c88;
    }
    .customer-stripe-request {
      display: inline-flex; align-items: center; margin-left: .3em;
      background: #fde68a; color: #b45309; border-radius: 50%; width:1.1em; height:1.1em;
      justify-content:center; font-size:.92em; box-shadow:0 0 2px #b4530988;
    }
    .customer-pending {
      display: inline-flex; align-items: center; margin-left: .3em;
      background: #fef08a; color: #ca8a04; border-radius: 50%; width:1.1em; height:1.1em;
      justify-content:center; font-size:.92em; box-shadow:0 0 2px #ca8a0488;
    }
    .customer-btn.active, #sidebar .customer-btn.active {
      background: #E5E7EB !important; border-radius: .375rem;
    }
    .update-fields { margin-top:1rem; }
    .update-row { display:flex; align-items:center; gap:.5rem; margin-bottom:.75rem; }
    #batch-bar {
      display:none; position:relative; margin-top:1rem; background:#f3f4f6;
      border:2px solid #000; border-radius:.5rem; padding:1rem;
      box-shadow:0 4px 24px #3332; text-align:center; font-weight:600;
      color:#333; z-index:30; align-items:center; justify-content:center;
      flex-direction:column;
    }
    #batch-bar.show { display:flex; }
    #batch-bar .bar-actions { display:flex; gap:1.5rem; justify-content:center; }
    #sidebar {
      width:auto!important; min-width:0; max-width:240px;
      padding-right:18px!important; padding-left:13px!important;
    }
    #sidebar .customer-btn { white-space: nowrap; }
    #sidebar h1 { white-space: nowrap; }
    .sidebar-divider {
      width:80%; height:2px; background:#e5e7eb; margin:12px auto 14px auto; border-radius:2px;
    }
    #email-modal-bg, #batch-modal-bg {
      display:none; position:fixed; inset:0; z-index:1000;
      background:rgba(31,41,55,0.7); justify-content:center; align-items:center;
    }
    #email-modal-bg.show, #batch-modal-bg.show { display:flex; }
    #email-modal, #batch-modal {
      background:#fff; border-radius:1.2rem; max-width:80vw; width:80vw;
      max-height:80vh; min-height:380px; box-shadow:0 8px 32px #0002;
      display:flex; flex-direction:column; padding:2rem 2rem 1.2rem 2rem;
      position:relative; overflow:auto; border:3px solid #000;
    }
    #email-modal .close-modal, #batch-modal .close-modal {
      position:absolute; top:12px; right:17px; cursor:pointer; font-size:2rem;
      font-weight:600; color:#e11d48; line-height:1; transition:color .15s;
      z-index:2000;
    }
    #email-modal .close-modal:hover, #batch-modal .close-modal:hover { color:#b91c1c; }
    #email-modal-list, #batch-modal-list { margin-bottom:1.5rem; }
    @media (max-width:900px) {
      #email-modal, #batch-modal { padding:1rem; max-width:98vw; width:98vw; }
    }
    @media (max-width:500px) {
      #email-modal, #batch-modal { min-height:220px; }
    }
    .spinner {
      display:inline-block; width:1.5em; height:1.5em; vertical-align:middle;
      border:3px solid #cbd5e1; border-top:3px solid #64748b;
      border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;
    }
    @keyframes spin { 100%{transform:rotate(360deg);} }
    .email-check {
      color:#22c55e; font-size:1.15em; margin-left:5px; vertical-align:middle;
    }
    .customer-id-label { font-weight:bold; margin-right:3px; }
    .log-entry { font-size:.92em; color:#475569; margin-bottom:6px; }
    .log-entry .dt { font-size:.85em; color:#999; margin-left:4px; }
    .pending-alert {
      background: #fef08a; color: #ca8a04; padding: .5em 1em; border-radius: .5em;
      margin-bottom: .6em; font-weight: 600; display: inline-block; font-size: 1em;
    }
    .stripe-request-box {
      background: #fef9c3; color: #92400e; border: 1.5px solid #fde68a;
      padding: .5em 1em; border-radius: .7em; margin-bottom: .7em;
      display: flex; align-items: center; gap: .7em;
    }
    .stripe-request-box input[type='url'] {
      border: 1.5px solid #fde68a; border-radius: .3em; padding: .2em .5em;
      min-width: 140px;
    }
  </style>
</head>
<body class="flex h-screen bg-gray-50">

  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Admin Login</h2>
      <input id="admin-pin" type="password" maxlength="4" placeholder="4-digit PIN"
             class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-gray-300">
      <button id="login-btn" class="w-full py-4 bg-gray-200 text-black rounded-lg hover:bg-gray-300
                                  flex justify-center items-center text-lg font-semibold transition">
        <span id="login-btn-text">Login</span>
        <span id="login-btn-spinner" class="spinner hidden"></span>
      </button>
      <p id="pin-error" class="mt-2 text-red-600"></p>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="email-modal-bg">
    <!-- â€¦ unchanged â€¦ -->
  </div>

  <!-- Batch Action Modal -->
  <div id="batch-modal-bg">
    <!-- â€¦ unchanged â€¦ -->
  </div>

  <!-- Sidebar -->
  <nav id="sidebar" class="hidden flex-shrink-0 flex-col bg-white p-4 shadow-lg">
    <h1 class="mb-4 text-2xl font-bold">Admin</h1>
    <button data-target="dashboard"
            class="nav-link mb-2 flex w-full items-center rounded px-2 py-1 text-left text-gray-700 hover:bg-gray-100">
      Dashboard
    </button>
    <div class="sidebar-divider"></div>
    <div class="mb-2 flex items-center">
      <span class="text-gray-700">ðŸ‘¥ Customers</span>
      <button id="add-cust-icon" class="ml-2 rounded bg-gray-200 px-2 py-1">+</button>
    </div>
    <ul id="sidebar-customer-list" class="space-y-1 text-gray-600"></ul>
  </nav>

  <!-- Main Content -->
  <div id="main" class="hidden flex flex-1 flex-col">
    <header class="bg-white shadow-md">
      <div class="px-4 py-3">
        <h2 id="page-title" class="text-xl font-semibold">Dashboard</h2>
      </div>
    </header>
    <main class="mx-auto flex-1 max-w-4xl overflow-auto p-6 space-y-6 w-full">
      <!-- Dashboard Panels -->
      <section id="dashboard" class="space-y-6">
        <!-- ... unchanged ... -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Total Customers</p>
            <p id="customersCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Outstanding Invoices</p>
            <p id="outstandingCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Unpaid Amount Due</p>
            <p id="unpaidAmount" class="text-3xl font-bold">$0.00</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Revenue This Month</p>
            <p id="revenueCount" class="text-3xl font-bold">$0.00</p>
          </div>
        </div>
        <div class="rounded-2xl bg-white p-6 shadow">
          <h3 class="mb-4 text-lg font-semibold">Invoice Tracking Calendar</h3>
          <div id="invoice-grid"></div>
          <div id="batch-bar">
            <div class="bar-actions w-full flex flex-row gap-4 justify-center">
              <button id="batch-email"
                      class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-2 px-5 rounded-lg">
                Send Email
              </button>
              <button id="batch-paid"
                      class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-2 px-5 rounded-lg">
                Mark All Paid
              </button>
            </div>
            <div class="mt-2"><span id="batch-count">0</span> selected.</div>
          </div>
        </div>
      </section>

      <!-- Add Customer -->
      <section id="customers" class="hidden space-y-8">
        <!-- ... unchanged ... -->
        <div class="mx-auto max-w-md rounded-2xl bg-white p-6 shadow">
          <h3 class="mb-4 text-xl font-semibold">+ Add Customer</h3>
          <input id="cust-id" placeholder="Customer ID" class="mb-4 w-full rounded-lg border p-4">
          <input id="cust-name" placeholder="Customer Name" class="mb-4 w-full rounded-lg border p-4">
          <input id="cust-email" type="email" placeholder="Customer Email (optional)" class="mb-4 w-full rounded-lg border p-4">
          <input id="cust-phone" type="tel" placeholder="Phone Number (optional)" class="mb-4 w-full rounded-lg border p-4">
          <input id="cust-address" placeholder="Address (optional)" class="mb-4 w-full rounded-lg border p-4">
          <button id="add-cust-btn" class="w-full rounded-lg bg-gray-300 py-3 text-black hover:bg-gray-400">
            Add Customer
          </button>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile" class="hidden space-y-6">
        <div class="mx-auto max-w-md space-y-4 rounded-2xl bg-white p-6 shadow">
          <h3 class="text-xl font-semibold">Customer Profile</h3>
          <p><strong>ID:</strong> <span id="profile-id"></span></p>
          <p><strong>Name:</strong> <span id="profile-name"></span></p>
          <p><strong>Email:</strong> <span id="profile-email"></span></p>
          <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
          <p><strong>Address:</strong> <span id="profile-address"></span></p>
          <p><strong>Customer PIN number:</strong> <span id="profile-pin"></span></p>
          <input id="invoice-amount" type="number" placeholder="Invoice Amount" class="mb-2 w-full rounded-lg border p-2">
          <button id="add-invoice-btn" class="w-full rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">
            Add Invoice
          </button>
          <ul id="profile-bills-list" class="space-y-2 pt-4"></ul>
          <div class="flex flex-row gap-2 mt-4">
            <button id="update-cust-btn" class="flex-1 rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">
              Update
            </button>
            <button id="delete-cust-btn" class="flex-1 rounded-lg bg-red-500 py-2 text-white hover:bg-red-600">
              Delete Customer
            </button>
          </div>
          <div id="update-fields" class="update-fields"></div>
          <div id="profile-email-log" class="mt-4"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Firestore initialization
      const firebaseConfig = {
        apiKey: "AIzaSyB2lKzEGU4YWV9-E9XILI3Gy0v80F2hJFc",
        authDomain: "customerportal-3032d.firebaseapp.com",
        projectId: "customerportal-3032d",
        storageBucket: "customerportal-3032d.appspot.com",
        messagingSenderId: "1003504088676",
        appId: "1:1003504088676:web:43453e986312257b2f5171",
        measurementId: "G-CVC0HK0WP8"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Helpers (unchanged)
      function generateUniquePin(existingPins) {
        let pin, tries = 0;
        do {
          pin = String(Math.floor(1000 + Math.random() * 9000));
          tries++;
          if (tries > 5000) throw new Error('Could not generate unique PIN');
        } while (existingPins.includes(pin));
        return pin;
      }
      async function getCustomers() {
        const snap = await db.collection('customers').get();
        return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }
      async function getBills() {
        const snap = await db.collection('bills').get();
        return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }
      function getEmailLog() {
        try { return JSON.parse(localStorage.getItem('emailLog') || '{}'); }
        catch(e) { return {}; }
      }
      function saveEmailLog(log) {
        try { localStorage.setItem('emailLog', JSON.stringify(log)); }
        catch(e) {}
      }

      // Metrics & calendar (unchanged)
      async function updateMetrics() {
        const customers = await getCustomers();
        const bills = await getBills();
        document.getElementById('customersCount').textContent = customers.length;
        const unpaid = bills.filter(b=>!b.paid);
        document.getElementById('outstandingCount').textContent = unpaid.length;
        document.getElementById('unpaidAmount').textContent =
          '$' + unpaid.reduce((s,b)=>s+b.amount,0).toFixed(2);
        const now = new Date(), m = now.getMonth(), y = now.getFullYear();
        const revenue = bills
          .filter(b=>b.paid && new Date(b.dueDate).getMonth()===m && new Date(b.dueDate).getFullYear()===y)
          .reduce((s,b)=>s+b.amount,0);
        document.getElementById('revenueCount').textContent = '$' + revenue.toFixed(2);
      }
      async function updateGrid() {
        const grid = document.getElementById('invoice-grid');
        grid.innerHTML = '';
        const now = new Date(), y = now.getFullYear(), m = now.getMonth();
        const firstDay = new Date(y,m,1).getDay();
        const daysInMonth = new Date(y,m+1,0).getDate();
        for(let i=0;i<firstDay;i++){
          const c=document.createElement('div'); c.className='grid-cell'; grid.appendChild(c);
        }
        const bills = await getBills();
        for(let d=1; d<=daysInMonth; d++){
          const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const dayBills = bills.filter(b=>b.dueDate===dateStr);
          const paidCount = dayBills.filter(b=>b.paid).length;
          const unpaidCount = dayBills.length - paidCount;
          const cell=document.createElement('div');
          cell.className='grid-cell '+(unpaidCount? 'unpaid': (dayBills.length?'paid':'' ));
          cell.textContent = dayBills.length? (unpaidCount||'âœ“') : '';
          grid.appendChild(cell);
        }
      }

      // DOM refs (unchanged)
      const loginOverlay    = document.getElementById('login-overlay');
      const loginBtn        = document.getElementById('login-btn');
      const loginBtnText    = document.getElementById('login-btn-text');
      const loginBtnSpinner = document.getElementById('login-btn-spinner');
      const pinInput        = document.getElementById('admin-pin');
      const pinError        = document.getElementById('pin-error');
      const sidebar         = document.getElementById('sidebar');
      const main            = document.getElementById('main');
      const navLinks        = document.querySelectorAll('.nav-link');
      const sidebarCustomerList = document.getElementById('sidebar-customer-list');
      const addCustIcon     = document.getElementById('add-cust-icon');
      const addCustBtn      = document.getElementById('add-cust-btn');
      const addInvoiceBtn   = document.getElementById('add-invoice-btn');
      const deleteCustBtn   = document.getElementById('delete-cust-btn');
      const updateCustBtn   = document.getElementById('update-cust-btn');
      const updateFieldsDiv = document.getElementById('update-fields');
      const batchBar        = document.getElementById('batch-bar');
      const batchPaidBtn    = document.getElementById('batch-paid');
      const batchEmailBtn   = document.getElementById('batch-email');
      const batchCount      = document.getElementById('batch-count');
      let activeCustomer = null, selectedCustomerIds = [];

      function showSection(id){
        ['dashboard','customers','profile'].forEach(s=>{
          document.getElementById(s).style.display = (s===id?'block':'none');
        });
        document.getElementById('page-title').textContent = id.charAt(0).toUpperCase()+id.slice(1);
        if(id!=='profile') document.querySelectorAll('.customer-btn').forEach(b=>b.classList.remove('active'));
      }
      navLinks.forEach(link=>{
        link.addEventListener('click',e=>{
          e.preventDefault();
          navLinks.forEach(l=>l.classList.remove('active'));
          link.classList.add('active');
          showSection(link.getAttribute('data-target'));
        });
      });
      function customerHasMissingInfo(c){
        return !c.email||!c.phone||!c.address;
      }

      // ==== MODIFIED: Sidebar now also shows ! for stripeRequested and pending for paymentPending ====
      async function populateSidebar(){
        const emailLog = getEmailLog();
        sidebarCustomerList.innerHTML = '';
        const customers = await getCustomers();
        const bills = await getBills();

        customers.sort((a,b)=>+a.id-+b.id).forEach(c=>{
          const btn = document.createElement('button');
          btn.className = 'customer-btn w-full text-left px-2 py-1 flex items-center justify-between';
          let html = `<span><span class="customer-id-label">${c.id} -</span> ${c.name}</span>`;

          // Show warning if missing info
          if(customerHasMissingInfo(c)) html += `<span class="customer-warning" title="Missing info">!</span>`;

          // Show check if emailed
          if(emailLog[c.id]) html += ` <span class="email-check" title="Emailed">&#10003;</span>`;

          // NEW: Add ! for stripeRequested invoice (and no link yet)
          const custBills = bills.filter(b=>b.customerId === c.id);
          const needsStripe = custBills.some(b => b.stripeRequested && !b.stripeLink && !b.paid);
          if (needsStripe) html += `<span class="customer-stripe-request" title="Stripe link requested">!</span>`;

          // NEW: Add Pending Payment icon for paymentPending invoice
          const pendingPay = custBills.some(b => b.paymentPending && !b.paid);
          if (pendingPay) html += `<span class="customer-pending" title="Payment pending">!</span>`;

          btn.innerHTML = html;
          btn.onclick = () => openCustomer(c.id);
          const li = document.createElement('li'); li.appendChild(btn);
          sidebarCustomerList.appendChild(li);
        });
      }

      // ==== MODIFIED: Render bills in profile for Stripe requests and payment pending ====
      async function openCustomer(id){
        const customers = await getCustomers();
        activeCustomer = customers.find(c=>c.id===id);
        if(!activeCustomer) return;
        ['id','name','email','phone','address'].forEach(f=>{
          document.getElementById('profile-'+f).textContent = activeCustomer[f]||'';
        });
        document.getElementById('profile-pin').textContent = activeCustomer.pin;
        await renderBills();
        renderEmailLog();
        navLinks.forEach(l=>l.classList.remove('active'));
        document.querySelectorAll('.customer-btn').forEach(b=>{
          if(b.textContent.replace('!','').replace('âœ“','').trim().startsWith(activeCustomer.id+' -'))
            b.classList.add('active');
          else b.classList.remove('active');
        });
        showSection('profile');
        updateFieldsDiv.innerHTML = '';
      }

      function renderEmailLog(){
        const log = getEmailLog();
        const div = document.getElementById('profile-email-log');
        div.innerHTML = activeCustomer && log[activeCustomer.id]
          ? `<div class="log-entry">Last emailed: <span class="dt">${log[activeCustomer.id]}</span></div>`
          : '';
      }

      // ====== MODIFIED: Render Stripe request, Stripe link input, and Payment Pending review =====
      async function renderBills(){
        const listEl = document.getElementById('profile-bills-list');
        listEl.innerHTML = '';
        const bills = await getBills();
        let foundStripe = false, foundPending = false;
        bills.filter(b=>b.customerId===activeCustomer.id).forEach(b=>{
          const li = document.createElement('li');
          li.className = 'p-4 bg-gray-100 rounded mb-2';
          let html = `<p><strong>Amount:</strong> $${b.amount}</p>
                      <p><strong>Due:</strong> ${b.dueDate}</p>
                      <p><strong>Status:</strong> ${b.paid?'Paid': b.paymentPending?'Pending':'Unpaid'}</p>`;

          // ===== Stripe Link request and input =====
          if (!b.paid && b.stripeRequested && !b.stripeLink) {
            foundStripe = true;
            html += `<div class="stripe-request-box">
              <span>Stripe link requested</span>
              <input type="url" placeholder="Paste Stripe link" id="stripe-link-input-${b.id}">
              <button id="submit-stripe-link-${b.id}" class="bg-blue-500 text-white rounded px-3 py-1 text-sm">Submit</button>
            </div>`;
          } else if (!b.paid && b.stripeRequested && b.stripeLink) {
            html += `<div class="text-green-600 mb-2">Stripe payment link sent to customer</div>`;
          }

          // ===== Payment pending review =====
          if (!b.paid && b.paymentPending) {
            foundPending = true;
            html += `<div class="pending-alert">
              Pending payment confirmation:
              <button id="approve-payment-${b.id}" class="ml-2 bg-green-500 text-white px-2 py-1 rounded text-xs">Confirm</button>
              <button id="deny-payment-${b.id}" class="ml-2 bg-red-500 text-white px-2 py-1 rounded text-xs">Deny</button>
            </div>`;
          }

          // ===== Default mark paid button =====
          if (!b.paid && !b.paymentPending) {
            html += `<button id="pay-btn-${b.id}" class="mt-2 bg-green-400 text-white px-3 py-1 rounded">Mark Paid</button>`;
          }

          li.innerHTML = html;
          listEl.appendChild(li);

          // Event listeners for Stripe link submission
          if (!b.paid && b.stripeRequested && !b.stripeLink) {
            setTimeout(() => {
              const btn = document.getElementById(`submit-stripe-link-${b.id}`);
              const input = document.getElementById(`stripe-link-input-${b.id}`);
              if (btn && input) {
                btn.onclick = async () => {
                  const link = input.value.trim();
                  if (!link.startsWith('http')) {
                    alert('Please enter a valid URL');
                    return;
                  }
                  await db.collection('bills').doc(b.id).update({ stripeLink: link, stripeRequested: false });
                  renderBills(); // refresh
                  await populateSidebar();
                  alert('Stripe payment link saved and sent to customer.');
                };
              }
            }, 0);
          }

          // Event listeners for payment pending review
          if (!b.paid && b.paymentPending) {
            setTimeout(() => {
              const approveBtn = document.getElementById(`approve-payment-${b.id}`);
              const denyBtn    = document.getElementById(`deny-payment-${b.id}`);
              if (approveBtn) {
                approveBtn.onclick = async () => {
                  if (confirm('Confirm this payment as received?')) {
                    await db.collection('bills').doc(b.id).update({ paid: true, paymentPending: false });
                    renderBills();
                    await populateSidebar();
                  }
                };
              }
              if (denyBtn) {
                denyBtn.onclick = async () => {
                  if (confirm('Deny this payment?')) {
                    await db.collection('bills').doc(b.id).update({ paymentPending: false });
                    renderBills();
                    await populateSidebar();
                  }
                };
              }
            }, 0);
          }

          // Mark paid default
          if (!b.paid && !b.paymentPending) {
            setTimeout(() => {
              const payBtn = document.getElementById(`pay-btn-${b.id}`);
              if (payBtn) {
                payBtn.onclick = async ()=>{
                  await db.collection('bills').doc(b.id).update({paid:true});
                  await renderBills(); await updateMetrics(); await updateGrid();
                };
              }
            }, 0);
          }
        });
      }

      addCustIcon.onclick = ()=> showSection('customers');
      addCustBtn.onclick = async ()=>{
        const id = document.getElementById('cust-id').value.trim();
        const name = document.getElementById('cust-name').value.trim();
        if(!id||!name){ alert('ID and name required'); return; }
        const pins = (await getCustomers()).map(c=>c.pin);
        const pin = generateUniquePin(pins);
        await db.collection('customers').doc(id).set({
          id,name,
          email:document.getElementById('cust-email').value.trim(),
          phone:document.getElementById('cust-phone').value.trim(),
          address:document.getElementById('cust-address').value.trim(),
          pin
        });
        ['cust-id','cust-name','cust-email','cust-phone','cust-address']
          .forEach(f=>document.getElementById(f).value='');
        await populateSidebar(); await updateMetrics(); await updateGrid();
        showSection('dashboard');
      };

      addInvoiceBtn.onclick = async ()=>{
        if(!activeCustomer){ alert('Select a customer'); return; }
        const amt = document.getElementById('invoice-amount').value.trim();
        if(!amt){ alert('Enter amount'); return; }
        const due = new Date().toISOString().slice(0,10);
        await db.collection('bills').add({
          customerId:activeCustomer.id,
          amount:parseFloat(amt),
          dueDate:due,
          paid:false,
          createdAt:new Date().toISOString()
        });
        document.getElementById('invoice-amount').value='';
        await renderBills(); await updateMetrics(); await updateGrid();
      };

      deleteCustBtn.onclick = async ()=>{
        if(!activeCustomer){ alert('Select a customer'); return; }
        if(!confirm(`Delete "${activeCustomer.name}" and all their invoices?`)) return;
        await db.collection('customers').doc(activeCustomer.id).delete();
        const snap = await db.collection('bills').where('customerId','==',activeCustomer.id).get();
        const batch = db.batch();
        snap.forEach(d=>batch.delete(d.ref));
        await batch.commit();
        activeCustomer = null;
        ['profile-id','profile-name','profile-email','profile-phone','profile-address','profile-pin']
          .forEach(f=>document.getElementById(f).textContent='');
        document.getElementById('profile-bills-list').innerHTML='';
        await populateSidebar(); await updateMetrics(); await updateGrid();
        showSection('dashboard');
      };

      updateCustBtn.onclick = ()=>{
        if(updateFieldsDiv.innerHTML!==''){ updateFieldsDiv.innerHTML=''; return; }
        if(!activeCustomer) return;
        const fields = [
          {key:'email',label:'Email',type:'email'},
          {key:'phone',label:'Phone Number',type:'tel'},
          {key:'address',label:'Address',type:'text'}
        ];
        const missing = fields.filter(f=>!activeCustomer[f.key]?.trim());
        if(!missing.length){
          updateFieldsDiv.innerHTML='<div class="text-green-700 mt-2">No missing information!</div>';
          return;
        }
        updateFieldsDiv.innerHTML = '';
        missing.forEach(f=>{
          const row = document.createElement('div'); row.className='update-row';
          const inp = document.createElement('input');
          inp.type=f.type; inp.placeholder=f.label; inp.className='border rounded px-2 py-1 flex-1';
          const btn = document.createElement('button');
          btn.textContent='Add'; btn.className='bg-gray-300 hover:bg-gray-400 text-black px-3 py-1 rounded ml-2';
          btn.onclick=async ()=>{
            const val = inp.value.trim();
            if(!val){ inp.classList.add('border-red-400'); return; }
            await db.collection('customers').doc(activeCustomer.id).update({[f.key]:val});
            activeCustomer[f.key]=val;
            document.getElementById('profile-'+f.key).textContent=val;
            row.remove();
            await populateSidebar(); await updateMetrics(); await updateGrid();
            if(!fields.filter(ff=>!activeCustomer[ff.key]?.trim()).length){
              updateFieldsDiv.innerHTML='<div class="text-green-700 mt-2">All information updated!</div>';
              setTimeout(()=>updateFieldsDiv.innerHTML='',2000);
            }
          };
          row.append(inp,btn); updateFieldsDiv.appendChild(row);
        });
      };

      function updateBatchBar(){
        batchBar.classList.toggle('show', selectedCustomerIds.length>0);
        batchCount.textContent = selectedCustomerIds.length;
      }
      batchPaidBtn.onclick = async ()=>{
        if(!selectedCustomerIds.length) return;
        if(!confirm('Mark all unpaid for selected?')) return;
        const bills = await getBills();
        const batch = db.batch();
        bills.filter(b=>selectedCustomerIds.includes(b.customerId)&&!b.paid)
             .forEach(b=>batch.update(db.collection('bills').doc(b.id),{paid:true}));
        await batch.commit();
        selectedCustomerIds = [];
        await updateMetrics(); await updateGrid(); updateBatchBar();
      };

      // Login flow (unchanged)
      loginBtn.onclick = async ()=>{
        pinError.textContent = '';
        if(pinInput.value === '1234'){
          loginBtnText.classList.add('hidden');
          loginBtnSpinner.classList.remove('hidden');
          loginBtn.disabled = true;
          try {
            await populateSidebar();
            await updateMetrics();
            await updateGrid();
            loginOverlay.classList.add('hidden');
            sidebar.classList.remove('hidden');
            main.classList.remove('hidden');
            document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');
            showSection('dashboard');
          } finally {
            loginBtnText.classList.remove('hidden');
            loginBtnSpinner.classList.add('hidden');
            loginBtn.disabled = false;
            pinInput.value = '';
          }
        } else {
          pinError.textContent = 'Invalid PIN';
        }
      };

      // Initial state: overlay visible; sidebar/main hidden via Tailwind
    });
  </script>
</body>
</html>
