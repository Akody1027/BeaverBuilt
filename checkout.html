<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Cart | Beaver Built Furniture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    /* Reset & Base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; padding: 20px; }
    a { color: inherit; text-decoration: none; }

    header {
      display: flex; align-items: center; margin-bottom: 20px;
    }
    .icon-btn {
      font-size: 1.5rem; margin-right: 10px; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      width: 32px; height: 32px; color: #1f2937;
    }
    header h1 {
      font-size: 1.5rem; font-weight: normal;
      flex: 1;
    }

    .cart-list {
      width: 100%; border-collapse: collapse; margin-bottom: 20px;
    }
    .cart-list th, .cart-list td {
      padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
    }
    .cart-list th { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; color: #555; }
    .cart-list img {
      width: 50px; height: 50px; object-fit: cover; border-radius: 4px;
    }

    .quantity-controls {
      display: flex; align-items: center;
    }
    .quantity-controls button {
      width: 24px; height: 24px; background: #e0e0e0; border: none;
      border-radius: 4px; font-size: 1rem; line-height: 0; cursor: pointer;
      margin: 0 5px;
    }
    .quantity-controls span {
      min-width: 20px; text-align: center; display: inline-block;
    }

    .discount-info {
      font-size: 0.85rem;
      color: #15803d; /* green */
      margin-top: 4px;
      font-weight: 600;
    }

    .totals {
      display: flex;
      justify-content: flex-end;
      padding-top: 10px;
      margin-right: 5px;
      margin-bottom: 25px;
      font-size: 1.1rem; font-weight: 600;
    }
    .totals span:last-child { margin-left: 10px; }

    /* Receipt checkbox styling */
    .receipt-checkbox {
      margin-bottom: 20px;
      margin-left: 35px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Shipping form - centered and modern button */
    #shipping-calculator {
      max-width: 85%;
      margin: 0 auto 20px auto;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      position: relative;
      left: 0px; /* shift right slightly */
      text-align: center;
    }
    #shipping-calculator label {
      margin-bottom: 6px;
      font-weight: 600;
      display: block;
      text-align: left;
    }
    #shipping-calculator input[type="text"],
    #shipping-calculator select {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    #shipping-options {
      margin-bottom: 15px;
      text-align: left;
    }
    #shipping-options label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
    }

    #get-rates-btn {
      display: block;
      margin: 20px auto 25px auto;
      padding: 10px 25px;
      background-color: #1f2937;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(31, 41, 55, 0.2);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    #get-rates-btn:hover {
      background-color: #374151;
      box-shadow: 0 6px 12px rgba(31, 41, 55, 0.3);
    }

    /* PayPal button container */
    #paypal-button-container {
      max-width: 90%;
      margin:auto;
      padding-left:5px;
    }

    /* Messages */
    #payment-message {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      color: green;
    }
    #payment-error {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      color: red;
    }

    /* Discount bubble */
    #discount-bubble {
      position: fixed;
      bottom: 30px;
      right: 20px;
      background: #fcd34d;
      color: #111;
      font-weight: 600;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 9999;
      font-size: 0.95rem;
      max-width: 280px;
      display: none;
    }
  </style>
</head>
<body>

  <header>
    <!-- Home button -->
    <a href="index.html" class="icon-btn" title="Home">
      <span class="material-icons">home</span>
    </a>
    <!-- Back button -->
    <span class="material-icons icon-btn" onclick="history.back()" title="Back">arrow_back</span>
    <h1>Your Cart</h1>
  </header>

  <table class="cart-list">
    <thead>
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="cart-body">
      <!-- JS injects rows here -->
    </tbody>
  </table>

  <div class="totals" style="margin-bottom: 50px;">
    <span>Items Total:</span><span id="cart-total">$0.00</span>
  </div>

  <div id="shipping-calculator">
    <label for="zip">Enter Shipping ZIP/Postal Code:</label>
    <input type="text" id="zip" placeholder="e.g. 90210" maxlength="10" />

    <label for="country">Country:</label>
    <select id="country">
      <option value="US" selected>United States</option>
      <option value="CA">Canada</option>
      <!-- Add more countries as needed -->
    </select>

    <button id="get-rates-btn" type="button">Get Shipping Rates</button>

    <div id="shipping-options"></div>

    <div class="totals">
      <span>Shipping:</span><span id="shipping-cost">$0.00</span>
    </div>

    <div class="totals">
      <span><strong>Order Total:</strong></span><span id="order-total">$0.00</span>
    </div>
  </div>

  <label class="receipt-checkbox">
    <input type="checkbox" id="download-receipt" />
    Download receipt after purchase
  </label>

  <div id="paypal-button-container"></div>

  <div id="payment-message"></div>
  <div id="payment-error"></div>

  <!-- Discount bubble -->
  <div id="discount-bubble">Coupon added</div>

  <!-- Load jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Load PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUolc9Il1ow4yOeARcTxKwMvRMV43EHSS9UFpc2SO3n0bOt5eSiZSTp6OgepodrHjKgOBzX5BdhUaHDi&currency=USD"></script>

  <script>
    const shippingClasses = {
      A: { weight: 2,  dimensions: [8, 6, 4], name: "Small Accessories" },
      B: { weight: 6,  dimensions: [12, 10, 6], name: "Wall Decor" },
      C: { weight: 18, dimensions: [24, 18, 10], name: "Bench" },
      D: { weight: 50, dimensions: [60, 24, 18], name: "Outdoor Bench" },
      E: { weight: 150, dimensions: [72, 36, 30], name: "Dining Table" }
    };

    function assignShippingClass(price) {
      if (price <= 100) return 'A';
      if (price <= 300) return 'B';
      if (price <= 700) return 'C';
      if (price <= 1500) return 'D';
      return 'E';
    }

    let cart = JSON.parse(localStorage.getItem('bbf_cart')||'[]');
    let shippingCost = 0;
    let selectedShippingOption = null;

    const cartBody = document.getElementById('cart-body');
    const cartTotalEl = document.getElementById('cart-total');
    const paymentMessage = document.getElementById('payment-message');
    const paymentError = document.getElementById('payment-error');
    const downloadReceiptCheckbox = document.getElementById('download-receipt');
    const zipInput = document.getElementById('zip');
    const countrySelect = document.getElementById('country');
    const getRatesBtn = document.getElementById('get-rates-btn');
    const shippingOptionsDiv = document.getElementById('shipping-options');
    const shippingCostEl = document.getElementById('shipping-cost');
    const orderTotalEl = document.getElementById('order-total');
    const discountBubble = document.getElementById('discount-bubble');

    // Total quantity helper
    function totalCartQuantity() {
      return cart.reduce((acc, item) => acc + item.qty, 0);
    }

    // Calculate discounted prices applying 10% off to all units after the first unit in total quantity
    function renderCart() {
      cartBody.innerHTML = '';
      let totalFullPrice = 0;
      let totalDiscountedPrice = 0;
      let unitsProcessed = 0;

      cart.forEach((item) => {
        let sub = 0;
        let discountAddedHtml = '';
        let discountedUnits = 0;
        let fullPriceUnits = 0;

        // Calculate how many units get discount and how many at full price
        if (unitsProcessed >= 1) {
          // All this item's units discounted
          discountedUnits = item.qty;
          fullPriceUnits = 0;
        } else if (unitsProcessed + item.qty <= 1) {
          // All units full price
          fullPriceUnits = item.qty;
          discountedUnits = 0;
        } else {
          // Some units full price (to complete first unit), rest discounted
          fullPriceUnits = 1 - unitsProcessed; // fraction to make total 1
          discountedUnits = item.qty - fullPriceUnits;
        }

        unitsProcessed += item.qty;

        // Calculate subtotal for this item with discount
        sub += item.price * fullPriceUnits;
        sub += item.price * 0.9 * discountedUnits;

        // Show discount message if any units discounted
        if (discountedUnits > 0) {
          discountAddedHtml = `<div class="discount-info">Discount added</div>`;
        }

        totalFullPrice += item.price * fullPriceUnits;
        totalDiscountedPrice += item.price * 0.9 * discountedUnits;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <img src="${item.img}" alt="" />
            ${item.itemNum}
          </td>
          <td>
            $${item.price.toFixed(2)}
            ${discountAddedHtml}
          </td>
          <td>
            <div class="quantity-controls">
              <button class="dec" data-id="${item.itemNum}">−</button>
              <span>${item.qty}</span>
              <button class="inc" data-id="${item.itemNum}">+</button>
            </div>
          </td>
          <td>$${sub.toFixed(2)}</td>
        `;
        cartBody.appendChild(tr);
      });

      const total = totalFullPrice + totalDiscountedPrice;
      cartTotalEl.textContent = '$' + total.toFixed(2);
      updateOrderTotal(total);
      attachQtyHandlers();
      checkForDiscountPrompt();
    }

    function attachQtyHandlers() {
      document.querySelectorAll('.inc').forEach(btn => {
        btn.onclick = () => adjustQty(btn.dataset.id, +1);
      });
      document.querySelectorAll('.dec').forEach(btn => {
        btn.onclick = () => adjustQty(btn.dataset.id, -1);
      });
    }

    function adjustQty(id, delta) {
      const idx = cart.findIndex(i=>i.itemNum==id);
      if (idx===-1) return;
      cart[idx].qty += delta;
      if (cart[idx].qty < 1) cart.splice(idx,1);
      localStorage.setItem('bbf_cart', JSON.stringify(cart));
      renderCart();
    }

    function calculatePackageFromCart() {
      if (cart.length === 0) return null;

      let totalWeight = 0;
      let maxLength = 0, maxWidth = 0, totalHeight = 0;

      cart.forEach(item => {
        const cls = item.shippingClass || assignShippingClass(item.price);
        const tier = shippingClasses[cls];
        if (!tier) return;

        const [length, width, height] = tier.dimensions;
        const qty = item.qty;

        totalWeight += tier.weight * qty;
        maxLength = Math.max(maxLength, length);
        maxWidth  = Math.max(maxWidth, width);
        totalHeight += height * qty;
      });

      return {
        weight: totalWeight,
        dimensions: [maxLength, maxWidth, totalHeight],
        name: 'Combined Package'
      };
    }

    function updateOrderTotal(totalFromCart) {
      const orderTotal = totalFromCart + shippingCost;
      orderTotalEl.textContent = '$' + orderTotal.toFixed(2);
    }

    function generatePDFReceipt(orderData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Beaver Built Furniture", 10, 20);
      doc.setFontSize(14);
      doc.text("Purchase Receipt", 10, 30);
      doc.setFontSize(12);
      doc.text(`Date: ${new Date().toLocaleString()}`, 10, 40);

      let y = 55;
      doc.text("Items Purchased:", 10, y);
      y += 10;

      orderData.items.forEach(item => {
        const line = `${item.name} (ID: ${item.itemNum}) x${item.quantity} - $${item.unit_amount.value}`;
        doc.text(line, 10, y);
        y += 10;
      });

      y += 10;
      doc.text(`Shipping Method: ${selectedShippingOption ? selectedShippingOption.label : 'N/A'}`, 10, y);
      y += 10;
      doc.text(`Shipping Cost: $${shippingCost.toFixed(2)}`, 10, y);

      y += 10;
      doc.text(`Total Paid: $${orderData.purchase_units[0].amount.value}`, 10, y);

      doc.save(`Receipt_${Date.now()}.pdf`);
    }

    async function fetchShippingRates(zip, country, packageInfo) {
      await new Promise(r=>setTimeout(r, 500)); // simulate network delay

      const base = packageInfo.weight;
      return [
        { id: 'standard', label: 'Standard Shipping (5-7 days)', amount: (5 + base * 0.5).toFixed(2) },
        { id: 'express', label: 'Express Shipping (2-3 days)', amount: (15 + base * 1.0).toFixed(2) },
        { id: 'overnight', label: 'Overnight Shipping', amount: (30 + base * 2.0).toFixed(2) },
      ];
    }

    function renderShippingOptions(options) {
      shippingOptionsDiv.innerHTML = '';
      if(options.length === 0) {
        shippingOptionsDiv.textContent = 'No shipping options found for this address/package.';
        return;
      }
      options.forEach(opt => {
        const id = 'ship_opt_' + opt.id;
        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = `${opt.label} - $${opt.amount}`;
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'shipping_option';
        radio.id = id;
        radio.value = opt.amount;
        if(opt === options[0]) {
          radio.checked = true;
          selectedShippingOption = opt;
          shippingCost = parseFloat(opt.amount);
          updateOrderTotal(calculateDiscountedTotal());
        }
        radio.onchange = () => {
          shippingCost = parseFloat(radio.value);
          selectedShippingOption = opt;
          shippingCostEl.textContent = '$' + shippingCost.toFixed(2);
          updateOrderTotal(calculateDiscountedTotal());
        };
        label.prepend(radio);
        shippingOptionsDiv.appendChild(label);
      });
      shippingCostEl.textContent = '$' + shippingCost.toFixed(2);
    }

    function calculateDiscountedTotal() {
      let unitsProcessed = 0;
      let total = 0;
      for (const item of cart) {
        let fullPriceUnits = 0;
        let discountedUnits = 0;

        if (unitsProcessed >= 1) {
          discountedUnits = item.qty;
        } else if (unitsProcessed + item.qty <= 1) {
          fullPriceUnits = item.qty;
        } else {
          fullPriceUnits = 1 - unitsProcessed;
          discountedUnits = item.qty - fullPriceUnits;
        }

        unitsProcessed += item.qty;
        total += item.price * fullPriceUnits + item.price * 0.9 * discountedUnits;
      }
      return total + shippingCost;
    }

    getRatesBtn.onclick = async () => {
      paymentMessage.textContent = '';
      paymentError.textContent = '';

      const zip = zipInput.value.trim();
      const country = countrySelect.value;
      if(!zip) {
        alert('Please enter your ZIP/postal code');
        return;
      }
      if(cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      const packageInfo = calculatePackageFromCart();
      if(!packageInfo) {
        alert('Could not determine package information');
        return;
      }

      try {
        const rates = await fetchShippingRates(zip, country, packageInfo);
        renderShippingOptions(rates);
      } catch(err) {
        paymentError.textContent = 'Failed to fetch shipping rates. Please try again later.';
        console.error(err);
      }
    };

    paypal.Buttons({
      createOrder: function(data, actions) {
        if(cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }
        if(!selectedShippingOption) {
          alert("Please select a shipping option.");
          return;
        }

        const itemsTotal = calculateDiscountedTotal() - shippingCost;
        const orderTotal = itemsTotal + shippingCost;

        const purchaseUnits = [{
          amount: {
            currency_code: "USD",
            value: orderTotal.toFixed(2),
            breakdown: {
              item_total: {
                currency_code: "USD",
                value: itemsTotal.toFixed(2)
              },
              shipping: {
                currency_code: "USD",
                value: shippingCost.toFixed(2)
              }
            }
          },
          items: (() => {
            let unitsProcessed = 0;
            return cart.map(item => {
              let fullPriceUnits = 0;
              let discountedUnits = 0;

              if (unitsProcessed >= 1) {
                discountedUnits = item.qty;
              } else if (unitsProcessed + item.qty <= 1) {
                fullPriceUnits = item.qty;
              } else {
                fullPriceUnits = 1 - unitsProcessed;
                discountedUnits = item.qty - fullPriceUnits;
              }
              unitsProcessed += item.qty;

              // Send two line items if both full price and discounted units exist
              if (fullPriceUnits > 0 && discountedUnits > 0) {
                return [
                  {
                    name: item.itemNum + ' (Full Price)',
                    unit_amount: {
                      currency_code: "USD",
                      value: item.price.toFixed(2)
                    },
                    quantity: fullPriceUnits.toString(),
                    item_category: "PHYSICAL_GOODS",
                    sku: item.itemNum
                  },
                  {
                    name: item.itemNum + ' (10% Discount)',
                    unit_amount: {
                      currency_code: "USD",
                      value: (item.price * 0.9).toFixed(2)
                    },
                    quantity: discountedUnits.toString(),
                    item_category: "PHYSICAL_GOODS",
                    sku: item.itemNum
                  }
                ];
              } else if (fullPriceUnits > 0) {
                return [{
                  name: item.itemNum,
                  unit_amount: {
                    currency_code: "USD",
                    value: item.price.toFixed(2)
                  },
                  quantity: fullPriceUnits.toString(),
                  item_category: "PHYSICAL_GOODS",
                  sku: item.itemNum
                }];
              } else {
                return [{
                  name: item.itemNum,
                  unit_amount: {
                    currency_code: "USD",
                    value: (item.price * 0.9).toFixed(2)
                  },
                  quantity: discountedUnits.toString(),
                  item_category: "PHYSICAL_GOODS",
                  sku: item.itemNum
                }];
              }
            }).flat();
          })(),
          shipping: {
            method: selectedShippingOption.label,
            address: {
              postal_code: zipInput.value.trim(),
              country_code: countrySelect.value
            }
          }
        }];

        return actions.order.create({
          purchase_units: purchaseUnits
        });
      },

      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          paymentMessage.textContent = "Payment completed successfully! Thank you.";
          paymentError.textContent = "";

          localStorage.removeItem('bbf_cart');
          cart = [];
          renderCart();

          if(downloadReceiptCheckbox.checked) {
            generatePDFReceipt(details);
          }
        });
      },

      onError: function(err) {
        paymentError.textContent = "An error occurred during payment. Please try again.";
        paymentMessage.textContent = "";
        console.error(err);
      }

    }).render('#paypal-button-container');

    function checkForDiscountPrompt() {
      const totalQty = totalCartQuantity();
      if (totalQty > 1) {
        discountBubble.style.display = 'block';
      } else {
        discountBubble.style.display = 'none';
      }
    }

    renderCart();
  </script>
</body>
</html>
