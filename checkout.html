<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Cart | Beaver Built Furniture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    /* Reset & Base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; padding: 20px; }
    a { color: inherit; text-decoration: none; }

    header {
      display: flex; align-items: center; margin-bottom: 20px;
    }
    .icon-btn {
      font-size: 1.5rem; margin-right: 10px; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      width: 32px; height: 32px; color: #1f2937;
    }
    header h1 {
      font-size: 1.5rem; font-weight: normal;
      flex: 1;
    }

    .cart-list {
      width: 100%; border-collapse: collapse; margin-bottom: 20px;
    }
    .cart-list th, .cart-list td {
      padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0;
    }
    .cart-list th { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; color: #555; }
    .cart-list img {
      width: 50px; height: 50px; object-fit: cover; border-radius: 4px;
    }

    .quantity-controls {
      display: flex; align-items: center;
    }
    .quantity-controls button {
      width: 24px; height: 24px; background: #e0e0e0; border: none;
      border-radius: 4px; font-size: 1rem; line-height: 0; cursor: pointer;
      margin: 0 5px;
    }
    .quantity-controls span {
      min-width: 20px; text-align: center; display: inline-block;
    }

    .totals {
      display: flex;
      Justify-content:flex-end;
      Padding-top:10px;
      Margin-right:5px;
      margin-bottom: 25px;
      font-size: 1.1rem; font-weight: 600;
    }
    .totals span:last-child { margin-left: 10px; }

    /* Receipt checkbox styling */
    .receipt-checkbox {
      margin-bottom: 20px;
      Margin-left:35px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Shipping form - centered and modern button */
    #shipping-calculator {
      max-width: 85%;
      margin: 0 auto 20px auto;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      position: relative;
      Left:0px; /* shift right slightly */
      text-align: center;
    }
    #shipping-calculator label {
      margin-bottom: 6px;
      font-weight: 600;
      display: block;
      text-align: left;
    }
    #shipping-calculator input[type="text"],
    #shipping-calculator select {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    #shipping-options {
      margin-bottom: 15px;
    }
    #shipping-options label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
    }

    #get-rates-btn {
      display: block;
      margin: 20px auto 25px auto;
      padding: 10px 25px;
      background-color: #1f2937;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(31, 41, 55, 0.2);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    #get-rates-btn:hover {
      background-color: #374151;
      box-shadow: 0 6px 12px rgba(31, 41, 55, 0.3);
    }

    /* PayPal button container */
    #paypal-button-container {
      max-width: 90%;
      margin:auto;
      padding-left:5px;
    }

    /* Messages */
    #payment-message {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      color: green;
    }
    #payment-error {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      color: red;
    }
  </style>
</head>
<body>

  <header>
    <!-- Home button -->
    <a href="index.html" class="icon-btn" title="Home">
      <span class="material-icons">home</span>
    </a>
    <!-- Back button -->
    <span class="material-icons icon-btn" onclick="history.back()" title="Back">arrow_back</span>
    <h1>Your Cart</h1>
  </header>

  <table class="cart-list">
    <thead>
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="cart-body">
      <!-- JS injects rows here -->
    </tbody>
  </table>

  <div class="totals"  style="margin-bottom: 50px;" >
    <span>Items Total:</span><span id="cart-total">$0.00</span>
  </div>

  <div id="shipping-calculator">
    <label for="zip">Enter Shipping ZIP/Postal Code:</label>
    <input type="text" id="zip" placeholder="e.g. 90210" maxlength="10" />

    <label for="country">Country:</label>
    <select id="country">
      <option value="US" selected>United States</option>
      <option value="CA">Canada</option>
      <!-- Add more countries as needed -->
    </select>

    <button id="get-rates-btn" type="button">Get Shipping Rates</button>

    <div id="shipping-options"></div>

    <div class="totals">
      <span>Shipping:</span><span id="shipping-cost">$0.00</span>
    </div>

    <div class="totals">
      <span><strong>Order Total:</strong></span><span id="order-total">$0.00</span>
    </div>
  </div>

  <label class="receipt-checkbox">
    <input type="checkbox" id="download-receipt" />
    Download receipt after purchase
  </label>

  <div id="paypal-button-container"></div>

  <div id="payment-message"></div>
  <div id="payment-error"></div>

  <!-- Load jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Load PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUolc9Il1ow4yOeARcTxKwMvRMV43EHSS9UFpc2SO3n0bOt5eSiZSTp6OgepodrHjKgOBzX5BdhUaHDi&currency=USD"></script>

  <script>
    // Your Shippo Test API Key (do NOT expose your live key on client side in production)
    const SHIPPO_API_KEY = 'shippo_test_e547ccec30861ed9dd6d18130ff3fe7ba7151f85';

    // Cart and shipping cost state
    let cart = JSON.parse(localStorage.getItem('bbf_cart')||'[]');
    let shippingCost = 0;
    let selectedShippingOption = null;

    // Package size tiers by price range
    const priceTiers = [
      { min: 0, max: 100, weight: 2, dimensions: [8,6,4], name: "Small Package" },
      { min: 101, max: 300, weight: 5, dimensions: [14,10,8], name: "Medium Package" },
      { min: 301, max: 700, weight: 10, dimensions: [20,14,10], name: "Large Package" },
      { min: 701, max: 1500, weight: 50, dimensions: [72,24,18], name: "Outdoor Bench" },
      { min: 1501, max: Infinity, weight: 150, dimensions: [72,40,30], name: "Dining Table" }
    ];

    // Elements
    const cartBody = document.getElementById('cart-body');
    const cartTotalEl = document.getElementById('cart-total');
    const paymentMessage = document.getElementById('payment-message');
    const paymentError = document.getElementById('payment-error');
    const downloadReceiptCheckbox = document.getElementById('download-receipt');
    const zipInput = document.getElementById('zip');
    const countrySelect = document.getElementById('country');
    const getRatesBtn = document.getElementById('get-rates-btn');
    const shippingOptionsDiv = document.getElementById('shipping-options');
    const shippingCostEl = document.getElementById('shipping-cost');
    const orderTotalEl = document.getElementById('order-total');

    // Render cart UI
    function renderCart() {
      cartBody.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const sub = item.price * item.qty;
        total += sub;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <img src="${item.img}" alt="" />
            ${item.itemNum}
          </td>
          <td>$${item.price.toFixed(2)}</td>
          <td>
            <div class="quantity-controls">
              <button class="dec" data-id="${item.itemNum}">âˆ’</button>
              <span>${item.qty}</span>
              <button class="inc" data-id="${item.itemNum}">+</button>
            </div>
          </td>
          <td>$${sub.toFixed(2)}</td>
        `;
        cartBody.appendChild(tr);
      });
      cartTotalEl.textContent = '$' + total.toFixed(2);
      updateOrderTotal();
      attachQtyHandlers();
    }

    function attachQtyHandlers() {
      document.querySelectorAll('.inc').forEach(btn => {
        btn.onclick = () => adjustQty(btn.dataset.id, +1);
      });
      document.querySelectorAll('.dec').forEach(btn => {
        btn.onclick = () => adjustQty(btn.dataset.id, -1);
      });
    }

    function adjustQty(id, delta) {
      const idx = cart.findIndex(i=>i.itemNum==id);
      if (idx===-1) return;
      cart[idx].qty += delta;
      if (cart[idx].qty < 1) cart.splice(idx,1);
      localStorage.setItem('bbf_cart', JSON.stringify(cart));
      renderCart();
    }

    // Map item price to package tier (weight, dims)
    function assignPackageForItem(price) {
      for(let tier of priceTiers) {
        if(price >= tier.min && price <= tier.max) return tier;
      }
      // fallback small
      return priceTiers[0];
    }

    // Calculate shipping package info for the whole cart aggregated
    // We will combine all items into a single package for simplicity,
    // using the heaviest tier found among items.
    function calculatePackageFromCart() {
      if(cart.length === 0) return null;
      let heaviestTier = priceTiers[0];
      cart.forEach(item => {
        const tier = assignPackageForItem(item.price);
        if(tier.weight > heaviestTier.weight) heaviestTier = tier;
      });
      return heaviestTier;
    }

    // Update displayed order total (items + shipping)
    function updateOrderTotal() {
      const itemsTotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      const orderTotal = itemsTotal + shippingCost;
      orderTotalEl.textContent = '$' + orderTotal.toFixed(2);
    }

    // Generate PDF receipt using jsPDF
    function generatePDFReceipt(orderData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Beaver Built Furniture", 10, 20);
      doc.setFontSize(14);
      doc.text("Purchase Receipt", 10, 30);
      doc.setFontSize(12);
      doc.text(`Date: ${new Date().toLocaleString()}`, 10, 40);

      let y = 55;
      doc.text("Items Purchased:", 10, y);
      y += 10;

      orderData.items.forEach(item => {
        const line = `${item.name} (ID: ${item.itemNum}) x${item.quantity} - $${item.unit_amount.value}`;
        doc.text(line, 10, y);
        y += 10;
      });

      y += 10;
      doc.text(`Shipping Method: ${selectedShippingOption ? selectedShippingOption.label : 'N/A'}`, 10, y);
      y += 10;
      doc.text(`Shipping Cost: $${shippingCost.toFixed(2)}`, 10, y);

      y += 10;
      doc.text(`Total Paid: $${orderData.purchase_units[0].amount.value}`, 10, y);

      doc.save(`Receipt_${Date.now()}.pdf`);
    }

    // Simulated fetch shipping rates (replace with real backend call)
    async function fetchShippingRates(zip, country, packageInfo) {
      await new Promise(r=>setTimeout(r, 500)); // simulate network delay

      const base = packageInfo.weight;
      return [
        { id: 'standard', label: 'Standard Shipping (5-7 days)', amount: (5 + base * 0.5).toFixed(2) },
        { id: 'express', label: 'Express Shipping (2-3 days)', amount: (15 + base * 1.0).toFixed(2) },
        { id: 'overnight', label: 'Overnight Shipping', amount: (30 + base * 2.0).toFixed(2) },
      ];
    }

    // Render shipping options radios
    function renderShippingOptions(options) {
      shippingOptionsDiv.innerHTML = '';
      if(options.length === 0) {
        shippingOptionsDiv.textContent = 'No shipping options found for this address/package.';
        return;
      }
      options.forEach(opt => {
        const id = 'ship_opt_' + opt.id;
        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = `${opt.label} - $${opt.amount}`;
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'shipping_option';
        radio.id = id;
        radio.value = opt.amount;
        if(opt === options[0]) {
          radio.checked = true;
          selectedShippingOption = opt;
          shippingCost = parseFloat(opt.amount);
          updateOrderTotal();
        }
        radio.onchange = () => {
          shippingCost = parseFloat(radio.value);
          selectedShippingOption = opt;
          shippingCostEl.textContent = '$' + shippingCost.toFixed(2);
          updateOrderTotal();
        };
        label.prepend(radio);
        shippingOptionsDiv.appendChild(label);
      });
      shippingCostEl.textContent = '$' + shippingCost.toFixed(2);
    }

    // Get Shipping Rates button handler
    getRatesBtn.onclick = async () => {
      paymentMessage.textContent = '';
      paymentError.textContent = '';

      const zip = zipInput.value.trim();
      const country = countrySelect.value;
      if(!zip) {
        alert('Please enter your ZIP/postal code');
        return;
      }
      if(cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      const packageInfo = calculatePackageFromCart();
      if(!packageInfo) {
        alert('Could not determine package information');
        return;
      }

      try {
        const rates = await fetchShippingRates(zip, country, packageInfo);
        renderShippingOptions(rates);
      } catch(err) {
        paymentError.textContent = 'Failed to fetch shipping rates. Please try again later.';
        console.error(err);
      }
    };

    // PayPal Buttons
    paypal.Buttons({
      createOrder: function(data, actions) {
        if(cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }
        if(!selectedShippingOption) {
          alert("Please select a shipping option.");
          return;
        }

        const itemsTotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        const orderTotal = itemsTotal + shippingCost;

        const purchaseUnits = [{
          amount: {
            currency_code: "USD",
            value: orderTotal.toFixed(2),
            breakdown: {
              item_total: {
                currency_code: "USD",
                value: itemsTotal.toFixed(2)
              },
              shipping: {
                currency_code: "USD",
                value: shippingCost.toFixed(2)
              }
            }
          },
          items: cart.map(item => ({
            name: item.itemNum,
            unit_amount: {
              currency_code: "USD",
              value: item.price.toFixed(2)
            },
            quantity: item.qty.toString(),
            item_category: "PHYSICAL_GOODS",
            sku: item.itemNum
          })),
          shipping: {
            method: selectedShippingOption.label,
            address: {
              postal_code: zipInput.value.trim(),
              country_code: countrySelect.value
            }
          }
        }];

        return actions.order.create({
          purchase_units: purchaseUnits
        });
      },

      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          paymentMessage.textContent = "Payment completed successfully! Thank you.";
          paymentError.textContent = "";

          // Clear cart
          localStorage.removeItem('bbf_cart');
          cart = [];
          renderCart();

          // Download receipt if checked
          if(downloadReceiptCheckbox.checked) {
            generatePDFReceipt(details);
          }
        });
      },

      onError: function(err) {
        paymentError.textContent = "An error occurred during payment. Please try again.";
        paymentMessage.textContent = "";
        console.error(err);
      }

    }).render('#paypal-button-container');

    // Initial render
    renderCart();
  </script>
</body>
</html>
